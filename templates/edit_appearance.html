{% extends "base.html" %} {% block body %}
<div class="container py-4">
  <h1 class="h4 mb-4">Edit Player Appearance</h1>
  <form id="eaf" class="row g-3">
    
    <!-- SECTION 1: Game & Player Info -->
    <div class="col-12">
      <h5 class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">Game & Player Information</h5>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">Game ID *</label>
      <input class="form-control" id="game_id" type="number" required placeholder="e.g., 1001" readonly />
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">Player *</label>
      <div class="input-group">
        <input class="form-control" id="player_name" placeholder="Search player..." autocomplete="off" required />
        <input type="hidden" id="player_id" />
      </div>
      <small id="player-search-results" class="form-text text-muted"></small>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">Date *</label>
      <input class="form-control" id="date" type="date" required />
    </div>

    <!-- SECTION 2: Club Info -->
    <div class="col-12">
      <h5 class="text-muted small text-uppercase fw-bold mt-3" style="letter-spacing: 0.5px;">Club Information</h5>
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Player's Club (During Match) *</label>
      <div class="input-group">
        <input class="form-control" id="player_club_name" placeholder="Search club..." autocomplete="off" required />
        <input type="hidden" id="player_club_id" />
      </div>
      <small id="club-search-results" class="form-text text-muted"></small>
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Player's Current Club</label>
      <div class="input-group">
        <input class="form-control" id="player_current_club_name" placeholder="Search club..." autocomplete="off" />
        <input type="hidden" id="player_current_club_id" />
      </div>
      <small id="current-club-search-results" class="form-text text-muted"></small>
    </div>

    <!-- SECTION 3: Performance Stats -->
    <div class="col-12">
      <h5 class="text-muted small text-uppercase fw-bold mt-3" style="letter-spacing: 0.5px;">Performance Statistics</h5>
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label">Minutes Played</label>
      <input class="form-control" id="minutes_played" type="number" min="0" max="120" placeholder="90" />
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label">Goals</label>
      <input class="form-control" id="goals" type="number" min="0" placeholder="0" value="0" />
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label">Assists</label>
      <input class="form-control" id="assists" type="number" min="0" placeholder="0" value="0" />
    </div>

    <!-- SECTION 4: Disciplinary -->
    <div class="col-12">
      <h5 class="text-muted small text-uppercase fw-bold mt-3" style="letter-spacing: 0.5px;">Disciplinary</h5>
    </div>

    <div class="col-6 col-md-4">
      <label class="form-label">Yellow Cards</label>
      <input class="form-control" id="yellow_cards" type="number" min="0" max="2" placeholder="0" value="0" />
    </div>

    <div class="col-6 col-md-4">
      <label class="form-label">Red Cards</label>
      <input class="form-control" id="red_cards" type="number" min="0" max="1" placeholder="0" value="0" />
    </div>

    <!-- SECTION 5: Submit -->
    <div class="col-12 pt-3 border-top">
      <button type="submit" id="submitBtn" class="btn btn-primary btn-lg">Update Appearance</button>
      <a href="/appearances" class="btn btn-secondary btn-lg">Cancel</a>
      <div id="result" class="mt-3"></div>
    </div>
  </form>
</div>

<script>
  // Search functions
  async function searchPlayers(query) {
    if (!query || query.length < 1) return [];
    try {
      const res = await fetch(`/api/players/search?q=${encodeURIComponent(query)}`);
      const data = await res.json();
      return data.rows || [];
    } catch (err) {
      console.error("Player search failed:", err);
      return [];
    }
  }

  async function searchClubs(query) {
    if (!query || query.length < 1) return [];
    try {
      const res = await fetch(`/api/clubs/search?q=${encodeURIComponent(query)}`);
      const data = await res.json();
      return data.rows || [];
    } catch (err) {
      console.error("Club search failed:", err);
      return [];
    }
  }

  const urlParams = new URLSearchParams(window.location.search);
  const appearanceId = urlParams.get("appearance_id");

  if (!appearanceId) {
    document.getElementById("result").textContent = "Error: Appearance ID not provided";
    document.getElementById("result").className = "mt-3 text-danger";
  } else {
    // Load appearance data
    async function loadAppearanceData() {
      try {
        const res = await fetch(`/api/appearance/${appearanceId}`);
        const data = await res.json();
        const appearance = data.row;

        if (!appearance) {
          document.getElementById("result").textContent = "Appearance not found";
          document.getElementById("result").className = "mt-3 text-danger";
          return;
        }

        // Fill form fields with data from database
        document.getElementById("game_id").value = appearance.game_id || "";
        document.getElementById("player_id").value = appearance.player_id || "";
        
        // Format date properly - ensure it's in YYYY-MM-DD format
        if (appearance.date) {
          const dateObj = new Date(appearance.date);
          const formattedDate = dateObj.toISOString().split('T')[0];
          document.getElementById("date").value = formattedDate;
        }
        
        document.getElementById("player_club_id").value = appearance.player_club_id || "";
        document.getElementById("player_current_club_id").value = appearance.player_current_club_id || "";
        document.getElementById("minutes_played").value = appearance.minutes_played || "";
        document.getElementById("goals").value = appearance.goals || 0;
        document.getElementById("assists").value = appearance.assists || 0;
        document.getElementById("yellow_cards").value = appearance.yellow_cards || 0;
        document.getElementById("red_cards").value = appearance.red_cards || 0;

        // Fetch and populate player name by ID
        if (appearance.player_id) {
          try {
            const playerRes = await fetch(`/api/player/${appearance.player_id}/profile`);
            const playerData = await playerRes.json();
            if (playerData.row && playerData.row.name) {
              document.getElementById("player_name").value = playerData.row.name;
            }
          } catch (err) {
            console.error("Failed to fetch player name:", err);
          }
        }

        // Fetch and populate club names by ID
        if (appearance.player_club_id) {
          try {
            const clubRes = await fetch(`/api/club/${appearance.player_club_id}/profile`);
            const clubData = await clubRes.json();
            if (clubData.row && clubData.row.name) {
              document.getElementById("player_club_name").value = clubData.row.name;
            }
          } catch (err) {
            console.error("Failed to fetch club name:", err);
          }
        }

        if (appearance.player_current_club_id) {
          try {
            const currentClubRes = await fetch(`/api/club/${appearance.player_current_club_id}/profile`);
            const currentClubData = await currentClubRes.json();
            if (currentClubData.row && currentClubData.row.name) {
              document.getElementById("player_current_club_name").value = currentClubData.row.name;
            }
          } catch (err) {
            console.error("Failed to fetch current club name:", err);
          }
        }
      } catch (err) {
        console.error("Failed to load appearance data:", err);
        document.getElementById("result").textContent = "Failed to load appearance data";
        document.getElementById("result").className = "mt-3 text-danger";
      }
    }

    window.addEventListener("load", loadAppearanceData);
  }

  // Player search
  let playerSearchTimeout;
  document.getElementById("player_name").addEventListener("input", async (e) => {
    clearTimeout(playerSearchTimeout);
    const query = e.target.value.trim();
    const resultsDiv = document.getElementById("player-search-results");

    if (!query) {
      resultsDiv.innerHTML = "";
      return;
    }

    playerSearchTimeout = setTimeout(async () => {
      const players = await searchPlayers(query);
      if (players.length === 0) {
        resultsDiv.innerHTML = '<span class="text-danger">No players found</span>';
        return;
      }

      let html = '<div class="list-group mt-2">';
      players.forEach(player => {
        html += `<button type="button" class="list-group-item list-group-item-action player-option" data-id="${player.player_id}" data-name="${player.name}">${player.name}</button>`;
      });
      html += '</div>';
      resultsDiv.innerHTML = html;

      document.querySelectorAll(".player-option").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          document.getElementById("player_name").value = btn.getAttribute("data-name");
          document.getElementById("player_id").value = btn.getAttribute("data-id");
          resultsDiv.innerHTML = "";
        });
      });
    }, 300);
  });

  // Club search function
  function setupClubSearch(nameInputId, idInputId, resultsId) {
    let searchTimeout;
    document.getElementById(nameInputId).addEventListener("input", async (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      const resultsDiv = document.getElementById(resultsId);

      if (!query) {
        resultsDiv.innerHTML = "";
        return;
      }

      searchTimeout = setTimeout(async () => {
        const clubs = await searchClubs(query);
        if (clubs.length === 0) {
          resultsDiv.innerHTML = '<span class="text-danger">No clubs found</span>';
          return;
        }

        let html = '<div class="list-group mt-2">';
        clubs.forEach(club => {
          html += `<button type="button" class="list-group-item list-group-item-action club-option" data-id="${club.club_id}" data-name="${club.name}">${club.name}</button>`;
        });
        html += '</div>';
        resultsDiv.innerHTML = html;

        document.querySelectorAll(".club-option").forEach(btn => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            document.getElementById(nameInputId).value = btn.getAttribute("data-name");
            document.getElementById(idInputId).value = btn.getAttribute("data-id");
            resultsDiv.innerHTML = "";
          });
        });
      }, 300);
    });
  }

  setupClubSearch("player_club_name", "player_club_id", "club-search-results");
  setupClubSearch("player_current_club_name", "player_current_club_id", "current-club-search-results");

  document.getElementById("eaf").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    if (!document.getElementById("player_id").value) {
      alert("Please select a player from the suggestions");
      return;
    }
    if (!document.getElementById("player_club_id").value) {
      alert("Please select a club from the suggestions");
      return;
    }

    const data = {
      game_id: parseInt(document.getElementById("game_id").value),
      player_id: parseInt(document.getElementById("player_id").value),
      date: document.getElementById("date").value,
      player_club_id: parseInt(document.getElementById("player_club_id").value),
      player_current_club_id: document.getElementById("player_current_club_id").value ? parseInt(document.getElementById("player_current_club_id").value) : null,
      minutes_played: document.getElementById("minutes_played").value ? parseInt(document.getElementById("minutes_played").value) : null,
      goals: Math.max(0, parseInt(document.getElementById("goals").value) || 0),
      assists: Math.max(0, parseInt(document.getElementById("assists").value) || 0),
      yellow_cards: Math.max(0, Math.min(2, parseInt(document.getElementById("yellow_cards").value) || 0)),
      red_cards: Math.max(0, Math.min(1, parseInt(document.getElementById("red_cards").value) || 0)),
    };

    const resEl = document.getElementById("result");
    resEl.textContent = "Saving...";
    resEl.className = "mt-3";

    try {
      const resp = await fetch(`/api/appearance/${appearanceId}/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      const body = await resp.json();
      if (!resp.ok) {
        resEl.textContent = "Error: " + (body.error || JSON.stringify(body)) + (body.details ? " — " + body.details : "");
        resEl.className = "mt-3 text-danger";
        console.error(body);
        return;
      }
      resEl.innerHTML = `✓ Appearance updated successfully`;
      resEl.className = "mt-3 text-success";
      setTimeout(() => {
        window.location.href = "/appearances";
      }, 1500);
    } catch (err) {
      resEl.textContent = "Request failed: " + err.message;
      resEl.className = "mt-3 text-danger";
      console.error(err);
    }
  });
</script>
{% endblock %}
