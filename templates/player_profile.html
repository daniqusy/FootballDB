{% extends "base.html" %} {% block body %}

<style>
  :root {
    --ink-900: #111827;
    --ink-700: #374151;
    --ink-500: #6b7280;
    --bg-card: #ffffff;
    --bg-soft: #f8fafc;
    --brand-500: #2563eb;
    --brand-600: #1d4ed8;
    --success-500: #16a34a;
    --warning-500: #f59e0b;
    --danger-500: #ef4444;
  }

  /* Layout + theme */
  .profile-hero {
    background: radial-gradient(1200px 500px at -10% -50%, rgba(37,99,235,0.08), rgba(37,99,235,0) 50%),
                radial-gradient(1200px 500px at 110% -50%, rgba(99,102,241,0.08), rgba(99,102,241,0) 50%),
                var(--bg-card);
    color: var(--ink-900);
    border-radius: 1rem;
    padding: 1.25rem 1.25rem;
    position: relative;
    box-shadow: 0 6px 24px rgba(16, 24, 40, 0.08);
    border: 1px solid #eef2f7;
  }
  .profile-hero .pp-img {
    border: 4px solid #fff;
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.2);
  }
  .mv-chip {
    background: #ecf2ff;
    color: var(--brand-600);
    padding: 0.4rem 0.6rem;
    border-radius: 0.5rem;
    font-weight: 700;
  }
  .stat-chip {
    background: var(--bg-card);
    border: 1px solid #eef0f4;
    border-radius: 0.9rem;
    padding: 0.9rem 0.8rem;
    box-shadow: 0 1px 2px rgba(16, 24, 40, 0.04);
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .stat-chip:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(16,24,40,.08); }
  .stat-chip .label {
    color: var(--ink-500);
    font-size: 0.8rem;
    letter-spacing: .02em;
    text-transform: uppercase;
  }
  .stat-chip .value { font-weight: 800; font-size: 1.25rem; color: var(--ink-900) }

  .filters .form-select { min-width: 180px; }
  .filters .btn { padding: 0.45rem 0.9rem; }
  .filters .filter-label { color: var(--ink-500); font-weight: 600; font-size: .85rem; margin-right: .35rem; }

  .table thead th { white-space: nowrap; }
  .table td, .table th { vertical-align: middle; }
  .table tbody tr:hover { background: #fbfdff; }

  .subtle { color: var(--ink-500); }

  .clickable { cursor: pointer; text-decoration: underline; text-underline-offset: 2px; }
  .clickable:hover { color: var(--brand-600); }

  .outcome-badge { font-weight: 800; letter-spacing: .04em; }
  .outcome-W { background: #e9f8ef; color: var(--success-500); }
  .outcome-D { background: #fff7e6; color: var(--warning-500); }
  .outcome-L { background: #feecec; color: var(--danger-500); }

  @media (max-width: 768px) {
    .filters .form-select { min-width: 120px; }
  }

  /* Meta badges (match timings + compare) */
  .meta-badge {
    display: inline-block;
    padding: 0.15rem 0.45rem;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #111827;
    font-size: 0.875rem;
  }
  .meta-badge.faster {
    background: #ecfdf5;
    border-color: #d1fae5;
    color: #065f46;
  }
  .meta-badge.slower {
    background: #fef2f2;
    border-color: #fee2e2;
    color: #991b1b;
  }
  .meta-sep { color: #9ca3af; padding: 0 0.25rem; }
  .meta-diff { color: #b91c1c; font-weight: 600; margin-left: 0.25rem; }
  .meta-badges { display: block; margin-top: 0.15rem; }
</style>

<div class="container py-3">
  <!-- Hero header -->
  <div class="profile-hero mb-3">
    <div class="d-flex align-items-center">
      <img
        id="pp-img"
        class="pp-img rounded-circle me-3"
        width="72"
        height="72"
        loading="lazy"
        onerror="this.style.display='none'"
      />
      <div class="me-auto">
        <div class="d-flex align-items-center gap-2">
          <h1 class="h4 mb-1" id="pp-name" style="font-weight: 800; letter-spacing: .2px"></h1>
          <span
            id="pp-pos"
            class="badge bg-light text-dark ms-2"
            style="font-size: 1rem; font-weight: 500"
          >
          </span>
        </div>
  <div class="subtle"><span id="pp-club" class="clickable"></span></div>
      </div>
      <div class="text-end">
        <div class="small" style="opacity: 0.9">Market value</div>
        <div id="pp-mv" class="mv-chip">—</div>
      </div>
    </div>
    <!-- Bio section -->
    <div class="row mt-3 g-2" id="pp-bio" style="font-size: 1.02rem">
      <div class="col-6 col-md-3">
        <span class="subtle">Height</span><br /><span
          id="bio-height"
          class="fw-semibold"
          >—</span
        >
        <span class="subtle">cm</span>
      </div>
      <div class="col-6 col-md-3">
        <span class="subtle">Age</span><br /><span
          id="bio-dob"
          class="fw-semibold clickable"
          >—</span
        >
      </div>
      <div class="col-6 col-md-3">
        <span class="subtle">Citizenship</span><br /><span
          id="bio-country"
          class="fw-semibold clickable"
          >—</span
        >
      </div>
      <div class="col-6 col-md-3">
        <span class="subtle">Foot</span><br /><span
          id="bio-foot"
          class="fw-semibold"
          >—</span
        >
      </div>
      <div class="col-6 col-md-3">
        <span class="subtle">Birth City</span><br /><span
          id="bio-city"
          class="fw-semibold clickable"
          >—</span
        >
      </div>
      <div class="col-6 col-md-3">
        <span class="subtle">Agent</span><br /><span
          id="bio-agent"
          class="fw-semibold clickable"
          >—</span
        >
      </div>
      <div class="col-6 col-md-3">
        <span class="subtle">Contract Expiry</span><br /><span
          id="bio-contract"
          class="fw-semibold"
          >—</span
        >
      </div>
    </div>
  </div>

  <!-- Stat chips -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md">
      <div class="stat-chip text-center">
        <div class="label">Goals</div>
        <div id="st-goals" class="value">0</div>
      </div>
    </div>
    <div class="col-6 col-md">
      <div class="stat-chip text-center">
        <div class="label">Assists</div>
        <div id="st-assists" class="value">0</div>
      </div>
    </div>
    <div class="col-6 col-md">
      <div class="stat-chip text-center">
        <div class="label">Minutes</div>
        <div id="st-min" class="value">0</div>
      </div>
    </div>
    <div class="col-6 col-md">
      <div class="stat-chip text-center">
        <div class="label">Yellow</div>
        <div id="st-yc" class="value">0</div>
      </div>
    </div>
    <div class="col-6 col-md">
      <div class="stat-chip text-center">
        <div class="label">Red</div>
        <div id="st-rc" class="value">0</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="d-flex flex-wrap align-items-center gap-2 mb-2 filters">
    <div class="d-flex align-items-center gap-2">
      <span class="filter-label">Competition</span>
      <select id="pp-comp" class="form-select"></select>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span class="filter-label">Season</span>
      <select id="pp-season" class="form-select"></select>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span class="filter-label">Source</span>
      <select id="pp-source" class="form-select form-select-sm" style="min-width:110px">
        <option value="sql">SQL</option>
        <option value="mongo">Mongo</option>
      </select>
    </div>
    <div class="form-check form-switch d-none" id="pp-compare-wrap" title="Compare SQL vs Mongo">
      <input class="form-check-input" type="checkbox" id="pp-compare" />
      <label class="form-check-label small" for="pp-compare">Compare</label>
    </div>
    <button id="pp-refresh" class="btn btn-primary btn-sm">Refresh</button>
    <small id="pp-meta" class="subtle ms-auto"></small>
    <button id="pp-perf-more" class="btn btn-link btn-sm text-decoration-none p-0" style="display:none">More…</button>
  </div>

  <!-- Matches -->
  <div class="card mb-4">
    <div class="card-header bg-white fw-semibold">Recent matches</div>
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th style="min-width: 260px">Fixture</th>
            <th>Score</th>
            <th class="text-end">
              <span title="Minutes"
                  ><span style="display:inline-block;vertical-align:middle;opacity:.85;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#232526" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  </span>
            </th>
            <th class="text-end">
              <span title="Goals">
                <img src="https://api.iconify.design/mdi:soccer.svg" alt="Goals" width="18" height="18" style="vertical-align:middle;opacity:.85;" />
              </span>
            </th>
            <th class="text-end">
              <span title="Assists">
                <img src="https://api.iconify.design/mdi:shoe-cleat.svg" alt="Assists" width="18" height="18" style="vertical-align:middle;opacity:.85;" />
              </span>
            </th>
            <th class="text-end">
              <span title="Yellow Cards"
                ><span
                  style="
                    display: inline-block;
                    width: 18px;
                    height: 18px;
                    background: #ffe066;
                    border-radius: 3px;
                    border: 1px solid #e0c200;
                    vertical-align: middle;
                  "
                ></span
              ></span>
            </th>
            <th class="text-end">
              <span title="Red Cards"
                ><span
                  style="
                    display: inline-block;
                    width: 18px;
                    height: 18px;
                    background: #fa5252;
                    border-radius: 3px;
                    border: 1px solid #c92a2a;
                    vertical-align: middle;
                  "
                ></span
              ></span>
            </th>
          </tr>
        </thead>
        <tbody id="pp-matches"></tbody>
      </table>
    </div>
  </div>

  <!-- Transfers -->
  <div class="card" id="career-card" style="display: none">
    <div class="card-header bg-white fw-semibold">Career transfers</div>
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>From</th>
            <th>To</th>
            <th class="text-end">Fee (€)</th>
            <th class="text-end">Market (€)</th>
          </tr>
        </thead>
        <tbody id="pp-career"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal: Market value comparison -->
<div class="modal fade" id="mv-compare-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mv-compare-title">Market value comparison</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:60px">Rank</th>
                <th>Name</th>
                <th class="text-end">Market value (€)</th>
              </tr>
            </thead>
            <tbody id="mv-compare-body">
              <tr><td colspan="3" class="text-center text-muted">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <small id="mv-compare-meta" class="text-muted me-auto"></small>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
  </div>

<script>
  async function J(u) {
    const r = await fetch(u);
    return r.json();
  }
  const url = new URL(window.location.href);
  const pid = url.searchParams.get("player_id");

  function num(x) {
    return x == null ? "—" : Number(x).toLocaleString();
  }

  function ageFromDob(dobStr) {
    const dob = new Date(dobStr);
    if (isNaN(dob)) return null;
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
    return age;
  }

  async function loadProfile() {
    const source = document.getElementById('pp-source').value;
    const base = source === 'mongo' ? '/api/mongo/player' : '/api/player';
    const prof = await J(`${base}/${pid}/profile`);
    const d = prof.row || {};
    document.getElementById("pp-name").textContent = d.name || pid;
    document.getElementById("pp-club").textContent = d.current_club_name || "";
    document.getElementById("pp-img").src = d.image_url || "";
    document.getElementById("pp-mv").textContent =
      "€" + num(d.market_value_eur);
    let pos = d.position || "";
    let sub = d.sub_position || "";
    const posEl = document.getElementById("pp-pos");
    posEl.textContent = pos
      ? sub
        ? `${pos} (${sub})`
        : pos
      : "";
    posEl.classList.add("clickable");
    document.getElementById("bio-height").textContent = d.height_in_cm || "—";
    const age = d.dob ? ageFromDob(d.dob) : null;
    document.getElementById("bio-dob").textContent =
      age != null ? `${age} years` : "—";
    document.getElementById("bio-country").textContent =
      d.country_of_citizenship || "—";
    document.getElementById("bio-foot").textContent = d.foot
      ? d.foot.charAt(0).toUpperCase() + d.foot.slice(1)
      : "—";
    document.getElementById("bio-city").textContent = d.city_of_birth || "—";
    document.getElementById("bio-agent").textContent = d.agent_name || "—";
    document.getElementById("bio-contract").textContent =
      d.contract_expiration_date
        ? new Date(d.contract_expiration_date).toLocaleDateString()
        : "—";

    // Attach compare interactions
    const attach = (el, cat, val, label) => {
      if (!val) return;
      el.addEventListener("click", () => openCompare(cat, val, label));
      el.title = `Compare by ${cat}`;
    };
    attach(document.getElementById("bio-dob"), "age", age, `${age} years`);
    attach(document.getElementById("bio-country"), "citizenship", d.country_of_citizenship, d.country_of_citizenship);
    attach(document.getElementById("pp-club"), "club", d.current_club_id, d.current_club_name);
    attach(posEl, "position", d.position, d.position);
    attach(document.getElementById("bio-agent"), "agent", d.agent_name, d.agent_name);
    attach(document.getElementById("bio-city"), "city", d.city_of_birth, d.city_of_birth);
  }

  let seasonsByComp = {};
  async function loadSeasonSummary() {
    const source = document.getElementById('pp-source').value;
    const base = source === 'mongo' ? '/api/mongo/player' : '/api/player';
    const s = await J(`${base}/${pid}/season-summary`);
    const compSel = document.getElementById("pp-comp");
    const seaSel = document.getElementById("pp-season");
    seasonsByComp = {};
    s.rows.forEach((r) => {
      (seasonsByComp[r.competition_id] ||= []).push(r.season);
    });
    // ensure seasons are unique and newest first
    Object.keys(seasonsByComp).forEach((cid) => {
      seasonsByComp[cid] = Array.from(new Set(seasonsByComp[cid]))
        .sort()
        .reverse();
    });
    // Fetch competition names
  const compRes = await J(`${source === 'mongo' ? '/api/mongo/players' : '/api/players'}/${pid}/competitions`);
    const compMap = {}; // id -> name
    const typeMap = {}; // id -> type
    compRes.rows.forEach((c) => {
      compMap[c.competition_id] = c.competition_name;
      typeMap[c.competition_id] = c.competition_type || "";
    });
    const normalizeType = (t) => String(t || "").toLowerCase().replace(/_/g, "-");
    // choose default comp: prefer domestic league
    let defaultCid = null;
    for (const cid of Object.keys(seasonsByComp).sort()) {
      const tt = normalizeType(typeMap[cid]);
      if (tt.includes("domestic") && tt.includes("league")) { defaultCid = cid; break; }
    }
    if (!defaultCid) defaultCid = Object.keys(seasonsByComp).sort()[0];
    compSel.innerHTML = "";
    Object.keys(seasonsByComp)
      .sort()
      .forEach((cid) => {
        const o = document.createElement("option");
        o.value = cid;
        o.textContent = compMap[cid] || cid;
        if (cid === defaultCid) o.selected = true;
        compSel.appendChild(o);
      });
    const firstComp = compSel.value || defaultCid;
    seaSel.innerHTML = "";
    (seasonsByComp[firstComp] || []).forEach((se) => {
      const o = document.createElement("option");
      o.value = se;
      o.textContent = se;
      seaSel.appendChild(o);
    });
    compSel.addEventListener("change", () => {
      seaSel.innerHTML = "";
      (seasonsByComp[compSel.value] || []).forEach((se) => {
        const o = document.createElement("option");
        o.value = se;
        o.textContent = se;
        seaSel.appendChild(o);
      });
    });
  }

  async function loadMatches() {
    const cid = document.getElementById("pp-comp").value;
    const sea = document.getElementById("pp-season").value;
    if (!cid || !sea) return;
    const sourceSel = document.getElementById('pp-source').value;
    const baseProfile = sourceSel === 'mongo' ? '/api/mongo/player' : '/api/player';
    const prof = await J(`${baseProfile}/${pid}/profile`);
    const playerClubName = prof.row?.current_club_name || "";
    const tb = document.getElementById("pp-matches");
    const compare = document.getElementById("pp-compare").checked;
    const baseUrl = sourceSel === 'mongo' ? '/api/mongo/player' : '/api/player';
    const res = await J(`${baseUrl}/${pid}/matches?competition_id=${cid}&season=${sea}`);
    let compareRes = null;
    let hasDiff = false;
    if (compare) {
      const otherBase = sourceSel === 'sql' ? '/api/mongo/player' : '/api/player';
      compareRes = await J(`${otherBase}/${pid}/matches?competition_id=${cid}&season=${sea}`);
      hasDiff = diffPlayerRows(
        sourceSel === 'sql' ? res.rows : compareRes.rows,
        sourceSel === 'sql' ? compareRes.rows : res.rows
      );
    }
  const metaEl = document.getElementById("pp-meta");
  const perfBtn = document.getElementById('pp-perf-more');
    // Activate perf modal button for SQL source
    if (sourceSel === 'sql' && res.perf){
      perfBtn.style.display='';
      perfBtn.onclick = () => openPerfModal('Player matches', res.perf, buildPlayerMatchesSQL(pid, cid, sea));
    } else {
      perfBtn.style.display='none';
    }

    if (compare && compareRes) {
      const aLabel = sourceSel.toUpperCase();
      const bLabel = sourceSel === 'sql' ? 'Mongo' : 'SQL';
      const aMs = res.ms;
      const bMs = compareRes.ms;
      const aFaster = Number(aMs) < Number(bMs);
      const bFaster = Number(bMs) < Number(aMs);
      const aClass = aFaster ? 'faster' : (bFaster ? 'slower' : '');
      const bClass = bFaster ? 'faster' : (aFaster ? 'slower' : '');
      metaEl.innerHTML = `
        <span>${res.rows.length} matches</span>
        <span class="meta-badges" style="display:block;margin-top:.15rem;">
          <span class="meta-badge ${aClass}">${aLabel} ${aMs} ms</span>
          <span class="meta-sep">|</span>
          <span class="meta-badge ${bClass}">${bLabel} ${bMs} ms</span>
          ${hasDiff ? '<span class="meta-diff">diff</span>' : ''}
        </span>
      `;
    } else {
      metaEl.innerHTML = `
        <span>${res.rows.length} matches</span>
        <span class="meta-badges" style="display:block;margin-top:.15rem;">
          <span class="meta-badge">${sourceSel.toUpperCase()} ${res.ms} ms</span>
        </span>
      `;
    }
    tb.innerHTML = "";
    let g = 0,
      a = 0,
      m = 0,
      y = 0,
      r = 0;
    res.rows.forEach((row) => {
      g += row.goals || 0;
      a += row.assists || 0;
      m += row.minutes_played || 0;
      y += row.yellow_cards || 0;
      r += row.red_cards || 0;
      const tr = document.createElement("tr");
      let opponent = "";
      if (playerClubName) {
        if (row.home_name === playerClubName) {
          opponent = row.away_name || row.away_club_id;
        } else if (row.away_name === playerClubName) {
          opponent = row.home_name || row.home_club_id;
        }
      }
      const fixture = `<span>${opponent}</span>`;
  // Determine outcome (W/D/L)
  let outcome = "";
      if (playerClubName) {
        if (row.home_name === playerClubName) {
          if (row.home_club_goals > row.away_club_goals) outcome = "W";
          else if (row.home_club_goals === row.away_club_goals) outcome = "D";
          else outcome = "L";
        } else if (row.away_name === playerClubName) {
          if (row.away_club_goals > row.home_club_goals) outcome = "W";
          else if (row.away_club_goals === row.home_club_goals) outcome = "D";
          else outcome = "L";
        }
      }
      const score = `
        <span class="badge outcome-badge outcome-${outcome}" style="min-width:1.9em;display:inline-block;text-align:center;">${outcome || '-'}</span>
        <span class="ms-1">${row.home_club_goals ?? "-"} - ${row.away_club_goals ?? "-"}</span>`;
      let formattedDate = "";
      if (row.date_str) {
        const d = new Date(row.date_str);
        const now = new Date();
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        if (d.getFullYear() === now.getFullYear()) {
          formattedDate = `${months[d.getMonth()]} ${d.getDate()}`;
        } else {
          formattedDate = `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
        }
      }
      tr.innerHTML = `
      <td>${formattedDate}</td>
      <td>${fixture}</td>
      <td>${score}</td>
      <td class="text-end">${row.minutes_played || 0}</td>
      <td class="text-end">${row.goals || 0}</td>
      <td class="text-end">${row.assists || 0}</td>
      <td class="text-end">${row.yellow_cards || 0}</td>
      <td class="text-end">${row.red_cards || 0}</td>`;
      tb.appendChild(tr);
    });
    document.getElementById("st-goals").textContent = g;
    document.getElementById("st-assists").textContent = a;
    document.getElementById("st-min").textContent = m.toLocaleString();
    document.getElementById("st-yc").textContent = y;
    document.getElementById("st-rc").textContent = r;
  }

  async function loadCareer() {
    const source = document.getElementById('pp-source').value;
    const base = source === 'mongo' ? '/api/mongo/player' : '/api/player';
    const c = await J(`${base}/${pid}/career`);
    const tb = document.getElementById("pp-career");
    const card = document.getElementById("career-card");
    tb.innerHTML = "";
    if (c.rows.length === 0) {
      card.style.display = "none";
      return;
    }
    card.style.display = "";
    c.rows.forEach((r) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
      <td>${r.transfer_date || ""}</td>
      <td>${r.from_club || ""}</td>
      <td>${r.to_club || ""}</td>
      <td class="text-end">${num(r.transfer_fee)}</td>
      <td class="text-end">${num(r.market_value_in_eur)}</td>`;
      tb.appendChild(tr);
    });
  }

  document.getElementById("pp-refresh").addEventListener("click", loadMatches);

  async function openCompare(category, value, label) {
    const title = document.getElementById("mv-compare-title");
    const body = document.getElementById("mv-compare-body");
    const meta = document.getElementById("mv-compare-meta");
    title.textContent = `Market value vs ${category}: ${label ?? value}`;
    body.innerHTML = `<tr><td colspan="3" class="text-center text-muted">Loading…</td></tr>`;
    try {
      const source = document.getElementById('pp-source').value;
      const base = source === 'mongo' ? '/api/mongo/market-compare' : '/api/market-compare';
      const data = await J(`${base}?category=${encodeURIComponent(category)}&value=${encodeURIComponent(value)}&limit=100`);
      const rows = data.rows || [];
      if (!rows.length) {
        body.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No data</td></tr>`;
      } else {
        body.innerHTML = "";
        let rank = 1;
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          const isSelf = String(r.player_id) === String(pid);
          tr.innerHTML = `
            <td>${rank++}</td>
            <td>${isSelf ? '<span class="badge text-bg-info me-1">You</span>' : ''}<a href="/player/profile?player_id=${r.player_id}" class="text-decoration-none">${r.name || r.player_id}</a></td>
            <td class="text-end">€${num(r.market_value_eur)}</td>
          `;
          if (isSelf) tr.classList.add("table-primary");
          body.appendChild(tr);
        });
      }
  meta.textContent = `Source: ${source.toUpperCase()} • Query time: ${data.ms} ms • ${rows.length} players`;
    } catch (e) {
      body.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Error loading data</td></tr>`;
      meta.textContent = "";
    }
    // Show modal (Bootstrap 5)
    let m = bootstrap.Modal.getOrCreateInstance(document.getElementById("mv-compare-modal"));
    m.show();
  }

  (async function init() {
    await loadProfile();
    await loadSeasonSummary();
    await loadMatches();
    await loadCareer();
    document.getElementById('pp-compare-wrap').classList.remove('d-none');
    document.getElementById('pp-compare').addEventListener('change', loadMatches);
    document.getElementById('pp-source').addEventListener('change', async () => {
      await loadProfile();
      await loadSeasonSummary();
      await loadMatches();
      await loadCareer();
    });
  })();

  // diff helper for player matches
  function corePlayer(r){
    return {
      date_str: r.date_str,
      minutes_played: r.minutes_played,
      goals: r.goals,
      assists: r.assists,
      home_club_goals: r.home_club_goals,
      away_club_goals: r.away_club_goals
    };
  }
  function diffPlayerRows(a,b){
    if (a.length !== b.length) return true;
    for (let i=0;i<a.length;i++){
      const ca = corePlayer(a[i]);
      const cb = corePlayer(b[i]);
      for (const k of Object.keys(ca)){
        if (ca[k] !== cb[k]) return true;
      }
    }
    return false;
  }

  function buildPlayerMatchesSQL(pid, comp, season){
    return `SELECT ... FROM appearance JOIN game WHERE player_id=${pid} AND competition_id=${comp} AND season='${season}' ORDER BY date DESC LIMIT 10`; // simplified
  }

  function openPerfModal(title, perf, sqlText){
    const id='pp-perf-modal';
    let wrap=document.getElementById(id);
    if(!wrap){
      wrap=document.createElement('div');
      wrap.id=id;wrap.className='modal fade';wrap.tabIndex=-1;
      wrap.innerHTML=`<div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Query Performance</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="pp-perf-body"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div>`;
      document.body.appendChild(wrap);
    }
    const body=wrap.querySelector('#pp-perf-body');
  body.innerHTML=`<h6 class="fw-semibold mb-2">${title}</h6><pre class="small bg-light p-2 rounded border" style="white-space:pre-wrap">${sqlText}</pre><table class="table table-sm mb-3"><tbody><tr><th style="width:180px">Execution time</th><td>${perf.execution_ms ?? '—'} ms</td></tr><tr><th>Diagnostics time</th><td>${perf.diagnostics_ms ?? '—'} ms</td></tr><tr><th>Total (exec + diag)</th><td>${perf.total_ms ?? '—'} ms</td></tr><tr><th style="width:180px">Rows examined</th><td>${perf.rows_examined ?? '—'}</td></tr><tr><th>Rows sent</th><td>${perf.rows_sent ?? '—'}</td></tr><tr><th>Explain type</th><td>${perf.explain_type ?? '—'}</td></tr></tbody></table><div class="mb-3"><div class="fw-semibold">Explain Plan</div><pre class="small bg-dark text-light p-2 rounded" style="max-height:240px;overflow:auto;white-space:pre-wrap">${(perf.explain||'No explain output')}</pre></div>`;
    bootstrap.Modal.getOrCreateInstance(wrap).show();
  }
</script>

{% endblock %}
