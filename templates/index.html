{% extends "base.html" %} {% block body %}
<style>
  /* Home page polish */
  .card {
    border: 1px solid #eef2f7;
    border-radius: 1rem;
  }
  .card-header {
    background: #fff;
    border-bottom: 1px solid #eef2f7;
  }
  .fixture-row {
    transition: background 0.15s ease, transform 0.12s ease;
  }
  .fixture-row:hover {
    background: #fbfdff;
    transform: translateY(-1px);
  }
  .score-box {
    background: linear-gradient(180deg, #f8fafc, #eef2f7);
    border: 1px solid #e5e7eb;
  }
  .search-empty {
    color: #6b7280;
  }
  .list-group-item.active {
    background-color: #1d4ed8;
    border-color: #1d4ed8;
  }
  .rank-badge {
    background: #ecfdf5;
    color: #065f46;
    font-weight: 700;
    min-width: 2rem;
    text-align: center;
  }
  .skeleton {
    position: relative;
    overflow: hidden;
    background: #f3f4f6;
    border-radius: 0.5rem;
  }
  .skeleton::after {
    content: "";
    position: absolute;
    inset: 0;
    transform: translateX(-100%);
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0) 0%,
      rgba(255, 255, 255, 0.6) 50%,
      rgba(255, 255, 255, 0) 100%
    );
    animation: shimmer 1.25s infinite;
  }
  @keyframes shimmer {
    100% {
      transform: translateX(100%);
    }
  }
  .inline-skeleton {
    display: inline-block;
    height: 1rem;
    width: 6rem;
    border-radius: 0.3rem;
  }
  /* Meta badges */
  .meta-line {
    font-size: 0.875rem;
    color: #6b7280;
  }
  .meta-badge {
    display: inline-block;
    padding: 0.15rem 0.45rem;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #111827;
  }
  .meta-badge.faster {
    background: #ecfdf5;
    border-color: #d1fae5;
    color: #065f46;
  }
  .meta-badge.slower {
    background: #fef2f2;
    border-color: #fee2e2;
    color: #991b1b;
  }
  .meta-sep {
    color: #9ca3af;
    padding: 0 0.25rem;
  }
  .meta-diff {
    color: #b91c1c;
    font-weight: 600;
    margin-left: 0.25rem;
  }
  .meta-badges {
    display: block;
    margin-top: 0.125rem;
  }
</style>
<div class="container-fluid">
  <div class="row">
    <!-- Left: player search -->
    <aside class="col-12 col-lg-2 mb-3">
      <div class="card">
        <div class="card-header fw-semibold">Search players/clubs</div>
        <div class="p-2">
          <input
            type="text"
            id="player-search"
            class="form-control form-control-sm"
            placeholder="Type a name…"
            autocomplete="off"
          />
        </div>
        <ul class="list-group list-group-flush" id="player-results">
          <li class="list-group-item text-muted">Start typing to search</li>
        </ul>
      </div>
    </aside>

    <!-- Center: matches feed by date -->
    <main class="col-12 col-lg-7 mb-3">
      <h2 class="h5 mb-2">Matches</h2>
      <!-- Row 1: date selection + navigation + go -->
      <div
        class="d-flex align-items-center flex-wrap gap-2 mb-1"
        id="matches-row-1"
      >
        <input
          type="date"
          id="match-date"
          class="form-control form-control-sm"
          style="max-width: 180px"
        />
        <button
          id="prev-btn"
          class="btn btn-sm btn-outline-secondary"
          title="Previous day"
        >
          <i class="bi bi-chevron-left"></i>
        </button>
        <button
          id="next-btn"
          class="btn btn-sm btn-outline-secondary"
          title="Next day"
        >
          <i class="bi bi-chevron-right"></i>
        </button>
        <button id="go-btn" class="btn btn-sm btn-primary">Go</button>
      </div>
      <!-- Row 2: data source / compare / timings & counts -->
      <div
        class="d-flex align-items-start flex-wrap gap-3 mb-2"
        id="matches-row-2"
      >
        <div class="d-flex align-items-center small" style="gap: 0.35rem">
          <label class="text-muted">Data source:</label>
          <select
            id="data-source"
            class="form-select form-select-sm"
            style="width: auto"
          >
            <option value="sql">SQL</option>
            <option value="mongo">Mongo</option>
          </select>
          <span
            style="cursor: help"
            title="Choose backend data source. Mongo populated via ETL."
            >ℹ️</span
          >
        </div>
        <div
          class="form-check form-switch d-none"
          id="compare-wrap"
          title="Fetch both sources and compare results"
        >
          <input class="form-check-input" type="checkbox" id="compare-toggle" />
          <label class="form-check-label small" for="compare-toggle"
            >Compare</label
          >
        </div>
        <small id="matches-meta" class="meta-line"></small>
        <button
          id="perf-more"
          class="btn btn-link btn-sm text-decoration-none p-0 ms-auto"
          style="display: none"
        >
          More…
        </button>
      </div>
      <div id="matches-container" class="vstack gap-3"></div>
    </main>

    <!-- Right: top players by market value -->
    <aside class="col-12 col-lg-3 mb-3">
      <div class="card">
        <div class="card-header fw-semibold">Top market values</div>
        <div
          class="p-2 d-flex align-items-center flex-wrap gap-2"
          id="top-market-controls"
        >
          <select
            id="top-market-source"
            class="form-select form-select-sm"
            style="width: auto"
          >
            <option value="sql">SQL</option>
            <option value="mongo">Mongo</option>
          </select>
          <div
            class="form-check form-switch"
            id="top-market-compare-wrap"
            title="Compare both sources"
          >
            <input
              class="form-check-input"
              type="checkbox"
              id="top-market-compare"
            />
            <label class="form-check-label small" for="top-market-compare"
              >Compare</label
            >
          </div>
          <button
            id="top-market-perf-more"
            class="btn btn-link btn-sm p-0 ms-auto"
            style="display: none"
          >
            More…
          </button>
        </div>
        <ul class="list-group list-group-flush" id="top-market">
          <li class="list-group-item">
            <span class="skeleton inline-skeleton"></span>
          </li>
          <li class="list-group-item">
            <span class="skeleton inline-skeleton" style="width: 8rem"></span>
          </li>
          <li class="list-group-item">
            <span class="skeleton inline-skeleton" style="width: 7rem"></span>
          </li>
          <li class="list-group-item">
            <span class="skeleton inline-skeleton" style="width: 9rem"></span>
          </li>
        </ul>
        <div class="card-footer">
          <small id="market-meta" class="text-muted"></small>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
  // Helpers
  async function fetchJSON(u) {
    const r = await fetch(u);
    return r.json();
  }

  function debounce(fn, delay = 300) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  function groupBy(xs, key) {
    return xs.reduce((acc, x) => {
      (acc[x[key]] ||= []).push(x);
      return acc;
    }, {});
  }

  function persistSource(val) {
    try {
      localStorage.setItem("match_source", val);
    } catch {}
  }
  function loadPersistedSource() {
    try {
      return localStorage.getItem("match_source") || "sql";
    } catch {
      return "sql";
    }
  }

  async function fetchMatches(source, dateStr) {
    const endpoint =
      source === "mongo"
        ? "/api/mongo/matches/by-date"
        : "/api/matches/by-date";
    const r = await fetch(endpoint + "?date=" + encodeURIComponent(dateStr));
    return r.json();
  }

  function coreComparable(row) {
    return {
      game_id: row.game_id,
      home_club_id: row.home_club_id,
      away_club_id: row.away_club_id,
      home_club_goals: row.home_club_goals,
      away_club_goals: row.away_club_goals,
    };
  }

  function diffRows(sqlRows, mongoRows) {
    if (sqlRows.length !== mongoRows.length) return true;
    const map = new Map(mongoRows.map((r) => [r.game_id, coreComparable(r)]));
    for (const r of sqlRows) {
      const m = map.get(r.game_id);
      if (!m) return true;
      const c = coreComparable(r);
      for (const k of Object.keys(c)) {
        if (c[k] !== m[k]) return true;
      }
    }
    return false;
  }

  async function loadMatches(dateStr) {
    const meta = document.getElementById("matches-meta");
    const cont = document.getElementById("matches-container");
    // Show loading skeleton
    cont.innerHTML = `
      <div class="card p-3"><div class="skeleton" style="height: 16px; width: 40%; margin-bottom: .5rem"></div>
      <div class="skeleton" style="height: 44px; width: 100%; margin-bottom: .5rem"></div>
      <div class="skeleton" style="height: 44px; width: 100%;"></div></div>`;
    const sourceSel = document.getElementById("data-source");
    const compare = document.getElementById("compare-toggle").checked;
    const source = sourceSel.value;
    let data = await fetchMatches(source, dateStr);
    let compareData = null;
    let hasDiff = false;
    if (compare) {
      const otherSource = source === "sql" ? "mongo" : "sql";
      compareData = await fetchMatches(otherSource, dateStr);
      hasDiff = diffRows(
        source === "sql" ? data.rows : compareData.rows,
        source === "sql" ? compareData.rows : data.rows
      );
    }
    const srcLabel = source.toUpperCase();
    // Performance modal activation: show if either SQL or Mongo perf is present
    const perfBtn = document.getElementById("perf-more");
    const sqlPerf =
      source === "sql" ? data.perf : compare ? compareData?.perf : null;
    const mongoPerf =
      source === "mongo" ? data.perf : compare ? compareData?.perf : null;
    const hasAnyPerf = Boolean(sqlPerf || mongoPerf);
    if (hasAnyPerf) {
      perfBtn.style.display = "";
      perfBtn.onclick = async () => {
        let enrichedMongoPerf = mongoPerf;
        let mongoCount =
          source === "mongo"
            ? data.rows?.length ?? null
            : compare
            ? compareData?.rows?.length ?? null
            : null;
        // Lazy fetch explain only when opening modal if Mongo part present and explain missing
        if (enrichedMongoPerf && enrichedMongoPerf.explain == null) {
          try {
            const resp = await fetch(
              `/api/mongo/matches/by-date?date=${encodeURIComponent(
                dateStr
              )}&perf=1`
            );
            const j = await resp.json();
            if (j.perf) {
              enrichedMongoPerf = j.perf;
              mongoCount = j.rows?.length ?? mongoCount;
            }
          } catch {}
        }
        openPerfModal(
          "Matches by date",
          {
            perf: sqlPerf,
            ms: source === "sql" ? data.ms : compare ? compareData?.ms : null,
            count:
              source === "sql"
                ? data.rows?.length ?? null
                : compare
                ? compareData?.rows?.length ?? null
                : null,
            sqlText: sqlPerf?.query || sqlQueryText(dateStr),
          },
          {
            perf: enrichedMongoPerf,
            ms: source === "mongo" ? data.ms : compare ? compareData?.ms : null,
            count: mongoCount,
          }
        );
      };
    } else {
      perfBtn.style.display = "none";
    }

    if (compare) {
      const otherLabel = source === "sql" ? "Mongo" : "SQL";
      const diffPill = hasDiff ? '<span class="meta-diff">diff</span>' : "";
      const aFaster = Number(data.ms) < Number(compareData.ms);
      const bFaster = Number(compareData.ms) < Number(data.ms);
      const aClass = aFaster ? "faster" : bFaster ? "slower" : "";
      const bClass = bFaster ? "faster" : aFaster ? "slower" : "";
      meta.innerHTML = `
        <span>${dateStr}</span>
        <span class="meta-sep">—</span>
        <span>${data.rows.length} matches</span>
        <span class="meta-badges">
          <span class="meta-badge ${aClass}">${srcLabel} ${data.ms} ms</span>
          <span class="meta-sep">|</span>
          <span class="meta-badge ${bClass}">${otherLabel} ${compareData.ms} ms</span>
          ${diffPill}
        </span>
      `;
    } else {
      meta.innerHTML = `
        <span>${dateStr}</span>
        <span class="meta-sep">—</span>
        <span>${data.rows.length} matches</span>
        <span class="meta-badges">
          <span class="meta-badge">${srcLabel} ${data.ms} ms</span>
        </span>
      `;
    }
    const byLeague = groupBy(data.rows, "league_id");
    // Clear skeleton before rendering actual content
    cont.innerHTML = "";
    if (!data.rows || data.rows.length === 0) {
      cont.innerHTML = `<div class="alert alert-light border">No matches for ${data.date}</div>`;
      return;
    }

    Object.keys(byLeague)
      .sort()
      .forEach((league) => {
        const card = document.createElement("div");
        card.className =
          "card league-card mb-3 bg-white text-dark rounded-4 shadow-sm";

        // League header (icon optional)
        const header = document.createElement("div");
        header.className =
          "card-header d-flex align-items-center border-0 bg-white text-dark fw-semibold";
        const leagueName =
          byLeague[league][0] && byLeague[league][0].league_name
            ? byLeague[league][0].league_name
            : league;
        header.innerHTML = `
      <span class="fw-semibold"><i class="bi bi-trophy-fill me-2"></i>${leagueName}</span>
    `;
        card.appendChild(header);

        const listWrap = document.createElement("div");
        listWrap.className = "p-2";

        byLeague[league].forEach((m) => {
          const hn = m.home_name || m.home_club_id;
          const an = m.away_name || m.away_club_id;
          const hs = m.home_club_goals ?? "-";
          const as = m.away_club_goals ?? "-";
          const status = m.status || "FT";

          const row = document.createElement("div");
          row.className =
            "fixture-row py-2 border-bottom border-light d-flex align-items-center justify-content-between";
          row.setAttribute("role", "button");
          row.addEventListener("click", () => {
            window.location.href = `/match?game_id=${m.game_id}`;
          });
          row.innerHTML = `
            <div class="d-flex align-items-center" style="min-width:40%">
              <span class="badge bg-secondary-subtle text-dark me-2">${status}</span>
              <a class="text-decoration-none fw-semibold me-2" href="/club?club_id=${m.home_club_id}" onclick="event.stopPropagation()">${hn}</a>
            </div>
            <div class="score-box px-3 py-1 rounded text-dark fw-bold mx-2" style="min-width:80px; text-align:center">
              ${hs} - ${as}
            </div>
            <div class="d-flex align-items-center" style="min-width:40%; justify-content:flex-end">
              <a class="text-decoration-none fw-semibold ms-2" href="/club?club_id=${m.away_club_id}" onclick="event.stopPropagation()">${an}</a>
            </div>`;
          listWrap.appendChild(row);
        });

        card.appendChild(listWrap);
        cont.appendChild(card);
      });
  }

  // Fallback SQL string for display when server doesn't provide perf.query
  function sqlQueryText(dateStr) {
    return (
      "SELECT\n" +
      "  g.competition_id                 AS league_id,\n" +
      "  g.game_id,\n" +
      "  g.home_club_id,  hc.name         AS home_name,\n" +
      "  g.away_club_id,  ac.name         AS away_name,\n" +
      "  g.home_club_goals, g.away_club_goals,\n" +
      "  c.name                            AS league_name\n" +
      "FROM game g\n" +
      "JOIN club hc ON hc.club_id = g.home_club_id\n" +
      "JOIN club ac ON ac.club_id = g.away_club_id\n" +
      "JOIN competition c ON c.competition_id = g.competition_id\n" +
      `WHERE g.date = '${dateStr}'\n` +
      "ORDER BY g.competition_id, g.game_id\n"
    );
  }

  function openPerfModal(title, sqlSection, mongoSection) {
    const modalId = "perf-modal";
    let wrap = document.getElementById(modalId);
    if (!wrap) {
      wrap = document.createElement("div");
      wrap.id = modalId;
      wrap.className = "modal fade";
      wrap.tabIndex = -1;
      wrap.innerHTML = `
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Query Performance</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="perf-body"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>`;
      document.body.appendChild(wrap);
    }
    const body = wrap.querySelector("#perf-body");
    const renderSQL = () => {
      if (!sqlSection?.perf) return "";
      const perf = sqlSection.perf || {};
      return `
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="fw-semibold mb-2">${title} — SQL</h6>
            <span class="badge text-bg-primary">${
              perf.execution_ms ?? perf.total_ms ?? ""
            } ms</span>
          </div>
          ${
            sqlSection.sqlText
              ? `<pre class="small bg-light p-2 rounded border" style="white-space:pre-wrap">${sqlSection.sqlText}</pre>`
              : ""
          }
          <table class="table table-sm mb-3">
            <tbody>
              <tr><th style="width:180px">Execution time</th><td>${
                perf.execution_ms ?? "—"
              } ms</td></tr>
              <tr><th>Diagnostics time</th><td>${
                perf.diagnostics_ms ?? "—"
              } ms</td></tr>
              <tr><th>Total (exec + diag)</th><td>${
                perf.total_ms ?? "—"
              } ms</td></tr>
              <tr><th style="width:180px">Rows examined</th><td>${
                perf.rows_examined ?? "—"
              }</td></tr>
              <tr><th>Rows sent</th><td>${perf.rows_sent ?? "—"}</td></tr>
              <tr><th>Explain type</th><td>${perf.explain_type ?? "—"}</td></tr>
            </tbody>
          </table>
          <div class="mb-3">
            <div class="fw-semibold">Explain Plan</div>
            <pre class="small bg-dark text-light p-2 rounded" style="max-height:240px;overflow:auto;white-space:pre-wrap">${
              perf.explain || "No explain output"
            }</pre>
          </div>
        </div>`;
    };

    const renderMongo = () => {
      const mp = mongoSection?.perf || {};
      const ms = mongoSection?.ms ?? mp.ms ?? mp.execution_ms ?? null;
      const stages = mp.explain || mp.stages || null;
      const stats = mp.stats || {};
      const queryText = mp.query
        ? typeof mp.query === "string"
          ? mp.query
          : JSON.stringify(mp.query, null, 2)
        : null;
      const hasDetails = Boolean(mongoSection?.perf);
      return `
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="fw-semibold mb-2">${title} — Mongo</h6>
            <span class="badge text-bg-success">${ms ?? "—"} ms</span>
          </div>
          ${
            queryText
              ? `<pre class="small bg-light p-2 rounded border" style="white-space:pre-wrap">${queryText}</pre>`
              : ""
          }
          <table class="table table-sm mb-3">
            <tbody>
              ${
                mongoSection?.count != null
                  ? `<tr><th style=\"width:180px\">Rows</th><td>${mongoSection.count}</td></tr>`
                  : ""
              }
              ${
                Object.keys(stats).length
                  ? Object.keys(stats)
                      .map((k) => `<tr><td>${k}</td><td>${stats[k]}</td></tr>`)
                      .join("")
                  : hasDetails
                  ? '<tr><td colspan="2" class="text-muted">No stats available</td></tr>'
                  : ""
              }
            </tbody>
          </table>
          ${
            hasDetails
              ? `
            <div>
              <div class="fw-semibold">Explain / Pipeline</div>
              <pre class="small bg-dark text-light p-2 rounded" style="max-height:240px;overflow:auto;white-space:pre-wrap">${
                stages
                  ? typeof stages === "string"
                    ? stages
                    : JSON.stringify(stages, null, 2)
                  : "No explain output"
              }</pre>
            </div>`
              : ""
          }
        </div>`;
    };

    body.innerHTML = `${renderSQL()}${renderMongo()}`;
    const modal = bootstrap.Modal.getOrCreateInstance(wrap);
    modal.show();
  }

  async function loadTopMarket() {
    const sourceSel = document.getElementById("top-market-source");
    const compare = document.getElementById("top-market-compare").checked;
    const source = sourceSel.value;
    const baseQ = "?k=10";
    const fetchOne = async (src) => {
      const ep =
        src === "mongo"
          ? "/api/mongo/players/top-market"
          : "/api/players/top-market";
      // Initial load: do NOT request Mongo explain; keep ms fast
      return fetchJSON(ep + baseQ); // SQL already returns perf via run_sql_ex
    };
    const primary = await fetchOne(source);
    let secondary = null;
    if (compare) {
      secondary = await fetchOne(source === "sql" ? "mongo" : "sql");
    }
    const ul = document.getElementById("top-market");
    ul.innerHTML = "";
    primary.rows.forEach((p, idx) => {
      const li = document.createElement("li");
      li.className =
        "list-group-item d-flex justify-content-between align-items-center";
      const val = (p.market_value_eur ?? 0).toLocaleString();
      li.innerHTML = `<span><span class="badge rank-badge me-2">${
        idx + 1
      }</span> <a href="/player/profile?player_id=${
        p.player_id
      }" class="text-decoration-none">${
        p.name || "Player " + p.player_id
      }</a></span>
                    <span class="badge text-bg-success">€${val}</span>`;
      ul.appendChild(li);
    });
    // Performance / compare meta badges
    const perfBtn = document.getElementById("top-market-perf-more");
    const sqlPerf =
      source === "sql" ? primary.perf : compare ? secondary?.perf : null;
    const mongoPerf =
      source === "mongo" ? primary.perf : compare ? secondary?.perf : null;
    const hasPerf = Boolean(sqlPerf || mongoPerf);
    if (hasPerf) {
      perfBtn.style.display = "";
      perfBtn.onclick = async () => {
        let enrichedMongoPerf = mongoPerf;
        let mongoCount =
          source === "mongo"
            ? primary.rows?.length ?? null
            : compare
            ? secondary?.rows?.length ?? null
            : null;
        if (enrichedMongoPerf && enrichedMongoPerf.explain == null) {
          try {
            const resp = await fetch(
              `/api/mongo/players/top-market?k=10&perf=1`
            );
            const j = await resp.json();
            if (j.perf) {
              enrichedMongoPerf = j.perf;
              mongoCount = j.rows?.length ?? mongoCount;
            }
          } catch {}
        }
        openPerfModal(
          "Top market values",
          {
            perf: sqlPerf,
            ms: source === "sql" ? primary.ms : compare ? secondary?.ms : null,
            count:
              source === "sql"
                ? primary.rows?.length ?? null
                : compare
                ? secondary?.rows?.length ?? null
                : null,
            sqlText:
              sqlPerf?.query ||
              "SELECT p.player_id, p.name, p.market_value_eur, p.current_club_id\nFROM player p\nWHERE p.market_value_eur IS NOT NULL\nORDER BY p.market_value_eur DESC\nLIMIT 10",
          },
          {
            perf: enrichedMongoPerf,
            ms:
              source === "mongo" ? primary.ms : compare ? secondary?.ms : null,
            count: mongoCount,
          }
        );
      };
    } else {
      perfBtn.style.display = "none";
    }
    // Meta badge rendering below list header controls
    const meta = document.getElementById("market-meta");
    if (compare && secondary) {
      const aFaster = Number(primary.ms) < Number(secondary.ms);
      const bFaster = Number(secondary.ms) < Number(primary.ms);
      const aClass = aFaster ? "faster" : bFaster ? "slower" : "";
      const bClass = bFaster ? "faster" : aFaster ? "slower" : "";
      meta.innerHTML = `<span class="meta-badges"><span class="meta-badge ${aClass}">${source.toUpperCase()} ${
        primary.ms
      } ms</span><span class="meta-sep">|</span><span class="meta-badge ${bClass}">${
        source === "sql" ? "Mongo" : "SQL"
      } ${secondary.ms} ms</span></span>`;
    } else {
      meta.innerHTML = `<span class="meta-badges"><span class="meta-badge">${source.toUpperCase()} ${
        primary.ms
      } ms</span></span>`;
    }
  }

  // Live player search
  function initPlayerSearch() {
    const input = document.getElementById("player-search");
    const list = document.getElementById("player-results");
    let selIndex = -1; // keyboard selection index across selectable items

    const renderMessage = (msg, cls = "text-muted") => {
      list.innerHTML = `<li class="list-group-item ${cls}">${msg}</li>`;
    };

    const doSearch = debounce(async () => {
      const q = input.value.trim();
      if (q.length < 2) {
        renderMessage("Type at least 2 characters");
        return;
      }
      renderMessage("Searching…");
      try {
        const [pdata, cdata] = await Promise.all([
          fetchJSON(`/api/players/search?q=${encodeURIComponent(q)}`),
          fetchJSON(`/api/clubs/search?q=${encodeURIComponent(q)}`),
        ]);
        const players = pdata.rows || [];
        const clubs = cdata.rows || [];
        if (!players.length && !clubs.length) {
          renderMessage("No matches");
          return;
        }
        list.innerHTML = "";
        selIndex = -1;

        const addHeader = (text) => {
          const h = document.createElement("li");
          h.className =
            "list-group-item text-uppercase small text-muted bg-light";
          h.textContent = text;
          h.dataset.header = "1";
          list.appendChild(h);
        };
        const addItem = (label, href) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center selectable";
          li.innerHTML = `<a class="text-decoration-none" href="${href}">${label}</a>`;
          li.dataset.href = href;
          li.addEventListener("mouseenter", () => {
            [...list.querySelectorAll(".selectable")].forEach((el) =>
              el.classList.remove("active")
            );
            li.classList.add("active");
            const items = [...list.querySelectorAll(".selectable")];
            selIndex = items.indexOf(li);
          });
          li.addEventListener("click", () => {
            window.location.href = href;
          });
          list.appendChild(li);
        };

        if (players.length) {
          addHeader("Players");
          players.forEach((p) =>
            addItem(p.name, `/player/profile?player_id=${p.player_id}`)
          );
        }
        if (clubs.length) {
          addHeader("Clubs");
          clubs.forEach((c) => addItem(c.name, `/club?club_id=${c.club_id}`));
        }
      } catch (e) {
        renderMessage("Error searching. Try again.", "text-danger");
      }
    }, 300);

    input.addEventListener("input", doSearch);
    input.addEventListener("keydown", (e) => {
      const items = [...list.querySelectorAll(".selectable")];
      if (!items.length) return;
      if (e.key === "ArrowDown") {
        e.preventDefault();
        selIndex = (selIndex + 1) % items.length;
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        selIndex = (selIndex - 1 + items.length) % items.length;
      } else if (e.key === "Enter") {
        const target = items[selIndex] || items[0];
        const href = target?.dataset?.href;
        if (href) window.location.href = href;
        return;
      } else {
        return; // other keys
      }
      items.forEach((el) => el.classList.remove("active"));
      if (items[selIndex]) items[selIndex].classList.add("active");
    });
  }

  async function fetchMaxDate(source) {
    const endpoint =
      source === "mongo"
        ? "/api/mongo/matches/max-date"
        : "/api/matches/max-date";
    const r = await fetch(endpoint);
    return r.json();
  }

  async function initDateAndLoad() {
    const input = document.getElementById("match-date");
    try {
      const sourceSel = document.getElementById("data-source");
      const d = await fetchMaxDate(sourceSel.value);
      const max = d.max_date; // 'YYYY-MM-DD' or null
      if (max) {
        input.max = max;
        input.value = max;
        await loadMatches(max);
      } else {
        // No games in DB; disable controls and show empty state
        input.disabled = true;
        document.getElementById("go-btn").disabled = true;
        document.getElementById("matches-meta").textContent =
          "No matches available";
      }
    } catch (e) {
      // Fallback: today, but cap by today
      const today = new Date().toISOString().slice(0, 10);
      input.max = today;
      input.value = today;
      await loadMatches(today);
    }
  }

  document.getElementById("go-btn").addEventListener("click", async () => {
    const v = document.getElementById("match-date").value;
    if (v) await loadMatches(v);
  });

  // Date navigation helpers
  function addDays(dateStr, delta) {
    const d = new Date(dateStr);
    d.setDate(d.getDate() + delta);
    return d.toISOString().slice(0, 10);
  }
  let maxMatchDate = null;
  document.getElementById("prev-btn").addEventListener("click", async () => {
    const input = document.getElementById("match-date");
    if (!input.value) return;
    const prev = addDays(input.value, -1);
    input.value = prev;
    await loadMatches(prev);
  });
  document.getElementById("next-btn").addEventListener("click", async () => {
    const input = document.getElementById("match-date");
    if (!input.value || !maxMatchDate) return;
    const next = addDays(input.value, 1);
    if (next > maxMatchDate) return; // cap at max
    input.value = next;
    await loadMatches(next);
  });

  // Source change handler
  document
    .getElementById("data-source")
    .addEventListener("change", async () => {
      const sel = document.getElementById("data-source").value;
      persistSource(sel);
      // refresh max date for new source
      try {
        const d = await fetchMaxDate(sel);
        maxMatchDate = d.max_date || null;
        const input = document.getElementById("match-date");
        if (maxMatchDate && (!input.value || input.value > maxMatchDate)) {
          input.value = maxMatchDate;
        }
      } catch {}
      if (document.getElementById("match-date").value) {
        await loadMatches(document.getElementById("match-date").value);
      }
      // reload top market values with new source
      loadTopMarket();
    });

  // Compare toggle rerun
  document
    .getElementById("compare-toggle")
    .addEventListener("change", async () => {
      const v = document.getElementById("match-date").value;
      if (v) await loadMatches(v);
    });

  // Run initial loads
  initPlayerSearch();
  // Initialize top-market controls
  (function initTopMarketControls() {
    const srcSel = document.getElementById("top-market-source");
    srcSel.addEventListener("change", () => loadTopMarket());
    document
      .getElementById("top-market-compare")
      .addEventListener("change", () => loadTopMarket());
    loadTopMarket();
  })();
  // Initialize source from persistence
  const persisted = loadPersistedSource();
  document.getElementById("data-source").value = persisted;
  // Expose compare toggle (dev/testing) – remove d-none class
  document.getElementById("compare-wrap").classList.remove("d-none");
  initDateAndLoad();
  // keep track of max date for next button
  (async () => {
    try {
      const sourceSel = document.getElementById("data-source");
      const d = await fetchMaxDate(sourceSel.value);
      maxMatchDate = d.max_date || null;
    } catch {}
  })();
</script>
{% endblock %}
