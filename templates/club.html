{% extends "base.html" %} {% block body %}
<div class="container my-3">
  <div class="mb-2">
    <a href="/" class="text-decoration-none">&larr; Back to home</a>
  </div>

  <!-- Club header -->
  <div class="card mb-3">
    <div class="card-body">
      <!-- Row 1: Title and club stats on left, ranking/ROI on right -->
      <div
        class="d-flex align-items-center justify-content-between flex-wrap gap-2"
      >
        <div>
          <div id="club-name" class="h4 mb-1 fw-semibold">Club</div>
          <div class="text-muted small" id="club-meta"></div>
          <div id="club-source-meta" class="small mt-1 text-muted"></div>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <button
            id="view-ranking"
            class="btn btn-sm btn-outline-secondary d-none"
            type="button"
            data-bs-toggle="modal"
            data-bs-target="#clubRankModal"
          >
            View ranking
          </button>
          <a
            id="roi-link"
            class="btn btn-sm btn-outline-primary d-none"
            href="#"
          >
            Transfer ROI
          </a>
        </div>
      </div>
      <!-- Row 2: Perf badges on left, Source/Compare/More on right -->
      <div
        class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-2"
      >
        <small id="club-perf-meta" class="text-muted"></small>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="d-flex align-items-center gap-1">
            <label for="club-source" class="small text-muted mb-0"
              >Source</label
            >
            <select
              id="club-source"
              class="form-select form-select-sm"
              style="min-width: 110px"
            >
              <option value="sql" selected>SQL</option>
              <option value="mongo">Mongo</option>
            </select>
          </div>
          <div
            class="form-check form-switch"
            id="club-compare-wrap"
            title="Compare SQL vs Mongo"
          >
            <input class="form-check-input" type="checkbox" id="club-compare" />
            <label class="form-check-label small" for="club-compare"
              >Compare</label
            >
          </div>
          <button
            id="club-perf-more"
            class="btn btn-link btn-sm p-0 text-decoration-none"
            style="display: none"
          >
            More…
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Squad -->
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold">Squad (by market value)</div>
        <ul id="squad" class="list-group list-group-flush">
          <li class="list-group-item text-muted">Loading…</li>
        </ul>
        <div class="card-footer">
          <small id="squad-meta" class="text-muted"></small>
        </div>
      </div>
    </div>

    <!-- Recent matches -->
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div
          class="card-header d-flex align-items-center justify-content-between"
        >
          <div class="fw-semibold">Recent matches</div>
          <div class="d-flex align-items-center gap-2">
            <label for="comp-select" class="small text-muted mb-0"
              >League</label
            >
            <select
              id="comp-select"
              class="form-select form-select-sm"
              style="min-width: 220px"
            ></select>
          </div>
        </div>
        <ul id="matches" class="list-group list-group-flush">
          <li class="list-group-item text-muted">Loading…</li>
        </ul>
        <div class="card-footer">
          <small id="matches-meta" class="text-muted"></small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Perf state holders
  let clubPerfSQL = {
    profile: null,
    squad: null,
    matches: null,
    competitions: null,
  };
  let clubPerfMongo = {
    profile: null,
    squad: null,
    matches: null,
    competitions: null,
  };
  let lastSQLMs = { profile: 0, squad: 0, matches: 0, competitions: 0 };
  let lastMongoMs = { profile: 0, squad: 0, matches: 0, competitions: 0 };
  function qs(key) {
    return new URLSearchParams(location.search).get(key);
  }
  async function fetchJSON(u) {
    const r = await fetch(u);
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  }

  function opponentRow(cId, g) {
    const isHome = g.home_club_id === cId;
    const oppId = isHome ? g.away_club_id : g.home_club_id;
    const oppName = isHome
      ? g.away_name || g.away_club_id
      : g.home_name || g.home_club_id;
    const gf = isHome ? g.home_club_goals : g.away_club_goals;
    const ga = isHome ? g.away_club_goals : g.home_club_goals;
    const outcome =
      gf == null || ga == null ? "-" : gf > ga ? "W" : gf < ga ? "L" : "D";

    const li = document.createElement("li");
    li.className =
      "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <span class="flex-grow-1 me-2 text-break">
        <span class="badge text-bg-light border me-2">${g.date_str}</span>
        <a class="text-decoration-none me-2" href="/match?game_id=${
          g.game_id
        }">${g.league_name || g.competition_id}</a>
        vs <a class="text-decoration-none" href="/club?club_id=${oppId}">${oppName}</a>
      </span>
      <span class="d-inline-flex align-items-center gap-2 flex-shrink-0 text-nowrap">
        <span class="badge text-bg-${
          outcome === "W" ? "success" : outcome === "L" ? "danger" : "secondary"
        }">${outcome}</span>
        <span class="fw-semibold">${g.home_club_goals ?? "-"}–${
      g.away_club_goals ?? "-"
    }</span>
      </span>`;
    return li;
  }

  function getSource() {
    return document.getElementById("club-source").value;
  }
  async function loadClub(cid, compare = false) {
    const base = getSource() === "mongo" ? "/api/mongo" : "/api";
    const data = await fetchJSON(`${base}/club/${cid}/profile`);
    if (!data.row) {
      document.getElementById("club-name").textContent = "Club not found";
      return;
    }
    if (getSource() === "sql") {
      clubPerfSQL.profile = data.perf;
      lastSQLMs.profile = data.ms;
    } else {
      clubPerfMongo.profile = data.perf;
      lastMongoMs.profile = data.ms;
    }
    if (compare) {
      const otherBase = getSource() === "sql" ? "/api/mongo" : "/api";
      const other = await fetchJSON(`${otherBase}/club/${cid}/profile`);
      if (getSource() === "sql") {
        clubPerfMongo.profile = other.perf;
        lastMongoMs.profile = other.ms;
      } else {
        clubPerfSQL.profile = other.perf;
        lastSQLMs.profile = other.ms;
      }
    }
    document.getElementById("club-name").textContent =
      data.row.name || "Club " + cid;
    // Meta: stadium + seats, average age
    const metaEl = document.getElementById("club-meta");
    const parts = [];
    if (data.row.stadium_name) {
      const seats =
        data.row.stadium_seats != null && data.row.stadium_seats !== ""
          ? ` (${Number(data.row.stadium_seats).toLocaleString()} seats)`
          : "";
      parts.push(`${data.row.stadium_name}${seats}`);
    }
    if (data.row.average_age != null) {
      parts.push(`Avg age ${data.row.average_age}`);
    }
    if (data.row.total_market_value_eur != null) {
      const mv = Number(data.row.total_market_value_eur).toLocaleString();
      const rank =
        data.row.market_value_rank != null && data.row.clubs_ranked != null
          ? ` — Rank #${data.row.market_value_rank} of ${data.row.clubs_ranked}`
          : "";
      parts.push(`Market value €${mv}${rank}`);
      document.getElementById("view-ranking").classList.remove("d-none");
    }
    metaEl.textContent = parts.join(" • ");
    // Link to ROI page prefilled with this club (season must be selected there)
    const roi = document.getElementById("roi-link");
    roi.href = `/club/roi?club_id=${encodeURIComponent(cid)}`;
    roi.classList.remove("d-none");
  }

  async function loadSquad(cid, compare = false) {
    const ul = document.getElementById("squad");
    const meta = document.getElementById("squad-meta");
    try {
      const base = getSource() === "mongo" ? "/api/mongo" : "/api";
      const data = await fetchJSON(`${base}/club/${cid}/players`);
      if (getSource() === "sql") {
        clubPerfSQL.squad = data.perf;
        lastSQLMs.squad = data.ms;
      } else {
        clubPerfMongo.squad = data.perf;
        lastMongoMs.squad = data.ms;
      }
      let other = null;
      if (compare) {
        const otherBase = getSource() === "sql" ? "/api/mongo" : "/api";
        other = await fetchJSON(`${otherBase}/club/${cid}/players`);
        if (getSource() === "sql") {
          clubPerfMongo.squad = other.perf;
          lastMongoMs.squad = other.ms;
        } else {
          clubPerfSQL.squad = other.perf;
          lastSQLMs.squad = other.ms;
        }
      }
      ul.innerHTML = "";
      if (!data.rows || !data.rows.length) {
        ul.innerHTML =
          '<li class="list-group-item text-muted">No current players recorded</li>';
        meta.textContent = "";
        return;
      }
      data.rows.forEach((p, idx) => {
        const li = document.createElement("li");
        li.className =
          "list-group-item d-flex justify-content-between align-items-center";
        const val = (p.market_value_eur ?? 0).toLocaleString();
        li.innerHTML = `
          <span>
            <span class="badge bg-secondary-subtle text-dark me-2">${
              idx + 1
            }</span>
            <a class="text-decoration-none" href="/player/profile?player_id=${
              p.player_id
            }">${p.name}</a>
            <small class="text-muted ms-2">${p.position || ""}${
          p.sub_position ? " • " + p.sub_position : ""
        }</small>
          </span>
          <span class="badge text-bg-success">€${val}</span>`;
        ul.appendChild(li);
      });
      if (compare && other) {
        const aFaster = Number(data.ms) < Number(other.ms);
        const bFaster = Number(other.ms) < Number(data.ms);
        const aClass = aFaster ? "faster" : bFaster ? "slower" : "";
        const bClass = bFaster ? "faster" : aFaster ? "slower" : "";
        meta.innerHTML = `<span class='meta-badges'><span class='meta-badge ${aClass}'>${getSource().toUpperCase()} ${
          data.ms
        } ms</span><span class='meta-sep'>|</span><span class='meta-badge ${bClass}'>${
          getSource() === "sql" ? "Mongo" : "SQL"
        } ${other.ms} ms</span></span>`;
      } else {
        meta.textContent = `Count ${data.rows.length} — ${data.ms} ms`;
      }
    } catch (e) {
      ul.innerHTML =
        '<li class="list-group-item text-danger">Failed to load squad</li>';
      meta.textContent = "";
    }
  }

  async function loadMatches(cid, competitionId, compare = false) {
    const ul = document.getElementById("matches");
    const meta = document.getElementById("matches-meta");
    try {
      const qs = new URLSearchParams({ limit: "12" });
      if (competitionId) qs.set("competition_id", competitionId);
      const base = getSource() === "mongo" ? "/api/mongo" : "/api";
      const data = await fetchJSON(
        `${base}/club/${cid}/matches?${qs.toString()}`
      );
      if (getSource() === "sql") {
        clubPerfSQL.matches = data.perf;
        lastSQLMs.matches = data.ms;
      } else {
        clubPerfMongo.matches = data.perf;
        lastMongoMs.matches = data.ms;
      }
      let other = null;
      if (compare) {
        const otherBase = getSource() === "sql" ? "/api/mongo" : "/api";
        other = await fetchJSON(
          `${otherBase}/club/${cid}/matches?${qs.toString()}`
        );
        if (getSource() === "sql") {
          clubPerfMongo.matches = other.perf;
          lastMongoMs.matches = other.ms;
        } else {
          clubPerfSQL.matches = other.perf;
          lastSQLMs.matches = other.ms;
        }
      }
      ul.innerHTML = "";
      if (!data.rows || !data.rows.length) {
        ul.innerHTML =
          '<li class="list-group-item text-muted">No matches found</li>';
        meta.textContent = "";
        return;
      }
      data.rows.forEach((g) => ul.appendChild(opponentRow(Number(cid), g)));
      if (compare && other) {
        const aFaster = Number(data.ms) < Number(other.ms);
        const bFaster = Number(other.ms) < Number(data.ms);
        const aClass = aFaster ? "faster" : bFaster ? "slower" : "";
        const bClass = bFaster ? "faster" : aFaster ? "slower" : "";
        const diff =
          data.rows.length !== other.rows.length
            ? "<span class='meta-diff'>diff</span>"
            : "";
        meta.innerHTML = `<span class='meta-badges'><span class='meta-badge ${aClass}'>${getSource().toUpperCase()} ${
          data.ms
        } ms</span><span class='meta-sep'>|</span><span class='meta-badge ${bClass}'>${
          getSource() === "sql" ? "Mongo" : "SQL"
        } ${other.ms} ms</span>${diff}</span>`;
      } else {
        meta.textContent = `Count ${data.rows.length} — ${data.ms} ms`;
      }
    } catch (e) {
      ul.innerHTML =
        '<li class="list-group-item text-danger">Failed to load matches</li>';
      meta.textContent = "";
    }
  }

  async function loadCompetitions(cid, compare = false) {
    const sel = document.getElementById("comp-select");
    sel.innerHTML = `<option value="">Loading…</option>`;
    try {
      const base = getSource() === "mongo" ? "/api/mongo" : "/api";
      const data = await fetchJSON(`${base}/club/${cid}/competitions`);
      if (getSource() === "sql") {
        clubPerfSQL.competitions = data.perf;
        lastSQLMs.competitions = data.ms;
      } else {
        clubPerfMongo.competitions = data.perf;
        lastMongoMs.competitions = data.ms;
      }
      if (compare) {
        const otherBase = getSource() === "sql" ? "/api/mongo" : "/api";
        const other = await fetchJSON(`${otherBase}/club/${cid}/competitions`);
        if (getSource() === "sql") {
          clubPerfMongo.competitions = other.perf;
          lastMongoMs.competitions = other.ms;
        } else {
          clubPerfSQL.competitions = other.perf;
          lastSQLMs.competitions = other.ms;
        }
      }
      const rows = data.rows || [];
      sel.innerHTML = "";
      if (!rows.length) {
        sel.innerHTML = `<option value="">All</option>`;
        sel.disabled = true;
        return null;
      }
      // Build options
      rows.forEach((r) => {
        const opt = document.createElement("option");
        opt.value = r.competition_id;
        opt.textContent = r.competition_name || r.competition_id;
        opt.dataset.type = r.type || "";
        sel.appendChild(opt);
      });
      // Prefer domestic-league by type
      const opts = [...sel.options];
      const preferred =
        opts.find((o) => {
          const t = (o.dataset.type || "").toLowerCase();
          return t === "domestic-league" || t === "domestic_league";
        }) || opts[0];
      if (preferred) preferred.selected = true;
      return preferred ? preferred.value : null;
    } catch (e) {
      sel.innerHTML = `<option value="">All</option>`;
      sel.disabled = true;
      return null;
    }
  }

  function refreshAll() {
    const cid = qs("club_id");
    if (!cid) return;
    const compare = document.getElementById("club-compare").checked;
    loadClub(cid, compare);
    loadSquad(cid, compare);
    loadCompetitions(cid, compare).then((defaultComp) => {
      loadMatches(cid, defaultComp || undefined, compare);
      // Store default competition for ranking modal usage
      const vr = document.getElementById("view-ranking");
      if (vr) vr.dataset.defaultComp = defaultComp || "";
    });
    updatePerfMeta(compare);
  }
  function updatePerfMeta(compare) {
    const el = document.getElementById("club-perf-meta");
    if (!el) return;
    const source = getSource();
    if (!compare) {
      const msSum =
        source === "sql"
          ? Object.values(lastSQLMs).reduce((a, b) => a + b, 0)
          : Object.values(lastMongoMs).reduce((a, b) => a + b, 0);
      el.innerHTML = `<span class='meta-badges'><span class='meta-badge'>${source.toUpperCase()} total ${msSum.toFixed(
        2
      )} ms</span></span>`;
      return;
    }
    const sqlTotal = Object.values(lastSQLMs).reduce((a, b) => a + b, 0);
    const mongoTotal = Object.values(lastMongoMs).reduce((a, b) => a + b, 0);
    const sqlFaster = sqlTotal < mongoTotal;
    const mongoFaster = mongoTotal < sqlTotal;
    const sqlClass = sqlFaster ? "faster" : mongoFaster ? "slower" : "";
    const mongoClass = mongoFaster ? "faster" : sqlFaster ? "slower" : "";
    el.innerHTML = `<span class='meta-badges'><span class='meta-badge ${sqlClass}'>SQL ${sqlTotal.toFixed(
      2
    )} ms</span><span class='meta-sep'>|</span><span class='meta-badge ${mongoClass}'>Mongo ${mongoTotal.toFixed(
      2
    )} ms</span></span>`;
  }
  (async function init() {
    const cid = qs("club_id");
    if (!cid) {
      alert("Missing club_id");
      return;
    }
    refreshAll();
    document.getElementById("comp-select").addEventListener("change", (e) => {
      const v = e.target.value || undefined;
      loadMatches(cid, v, document.getElementById("club-compare").checked);
    });
    document.getElementById("club-source").addEventListener("change", () => {
      refreshAll();
    });
    document
      .getElementById("club-compare")
      .addEventListener("change", () => refreshAll());
    // perf modal button
    document.getElementById("club-perf-more").onclick = async () => {
      // Lazy fetch mongo explains if absent and compare enabled
      const compare = document.getElementById("club-compare").checked;
      const cid = qs("club_id");
      if (compare) {
        // Fetch perf=1 for mongo endpoints if explain missing
        const needExplain = [
          "profile",
          "squad",
          "matches",
          "competitions",
        ].some((k) => clubPerfMongo[k] && clubPerfMongo[k].explain == null);
        if (needExplain) {
          try {
            await Promise.all([
              fetchJSON(`/api/mongo/club/${cid}/profile?perf=1`).then((r) => {
                clubPerfMongo.profile = r.perf;
              }),
              fetchJSON(`/api/mongo/club/${cid}/players?perf=1`).then((r) => {
                clubPerfMongo.squad = r.perf;
              }),
              fetchJSON(`/api/mongo/club/${cid}/matches?limit=12&perf=1`).then(
                (r) => {
                  clubPerfMongo.matches = r.perf;
                }
              ),
              fetchJSON(`/api/mongo/club/${cid}/competitions?perf=1`).then(
                (r) => {
                  clubPerfMongo.competitions = r.perf;
                }
              ),
            ]);
          } catch {}
        }
      }
      openClubPerfModal();
    };
    // show perf button if SQL perf exists
    document.getElementById("club-perf-more").style.display = "";
  })();

  function openClubPerfModal() {
    const id = "club-perf-modal";
    let wrap = document.getElementById(id);
    if (!wrap) {
      wrap = document.createElement("div");
      wrap.id = id;
      wrap.className = "modal fade";
      wrap.tabIndex = -1;
      wrap.innerHTML = `<div class='modal-dialog modal-lg modal-dialog-scrollable'><div class='modal-content'><div class='modal-header'><h5 class='modal-title'>Club Query Performance</h5><button type='button' class='btn-close' data-bs-dismiss='modal'></button></div><div class='modal-body'><div id='club-perf-body'></div></div><div class='modal-footer'><button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Close</button></div></div></div>`;
      document.body.appendChild(wrap);
    }
    const body = wrap.querySelector("#club-perf-body");
    const renderSQL = () => {
      const p = clubPerfSQL;
      if (!p.profile && !p.squad && !p.matches) return "";
      const section = (name, obj) =>
        obj
          ? `<div class='mb-3'><h6 class='fw-semibold mb-1'>${name}</h6><table class='table table-sm'><tbody><tr><th style='width:180px'>Exec ms</th><td>${
              obj.execution_ms ?? "—"
            }</td></tr><tr><th>Diag ms</th><td>${
              obj.diagnostics_ms ?? "—"
            }</td></tr><tr><th>Rows examined</th><td>${
              obj.rows_examined ?? "—"
            }</td></tr><tr><th>Rows sent</th><td>${
              obj.rows_sent ?? "—"
            }</td></tr><tr><th>Explain type</th><td>${
              obj.explain_type ?? "—"
            }</td></tr></tbody></table><pre class='small bg-light p-2 rounded border' style='white-space:pre-wrap'>${
              obj.query || ""
            }</pre><pre class='small bg-dark text-light p-2 rounded' style='max-height:200px;overflow:auto;white-space:pre-wrap'>${
              obj.explain || "No explain"
            }</pre></div>`
          : "";
      return `<div class='mb-4'><h5 class='fw-semibold'>SQL</h5>${section(
        "Profile",
        p.profile
      )}${section("Squad", p.squad)}${section("Matches", p.matches)}${section(
        "Competitions",
        p.competitions
      )}</div>`;
    };
    const renderMongo = () => {
      const p = clubPerfMongo;
      if (!p.profile && !p.squad && !p.matches) return "";
      const section = (name, obj) =>
        obj
          ? `<div class='mb-3'><h6 class='fw-semibold mb-1'>${name}</h6><table class='table table-sm'><tbody>${
              obj.stats
                ? Object.keys(obj.stats)
                    .map(
                      (k) =>
                        `<tr><th style='width:180px'>${k}</th><td>${obj.stats[k]}</td></tr>`
                    )
                    .join("")
                : ""
            }</tbody></table><pre class='small bg-light p-2 rounded border' style='white-space:pre-wrap'>${
              typeof obj.query === "string"
                ? obj.query
                : JSON.stringify(obj.query, null, 2)
            }</pre><pre class='small bg-dark text-light p-2 rounded' style='max-height:200px;overflow:auto;white-space:pre-wrap'>${
              obj.explain
                ? typeof obj.explain === "string"
                  ? obj.explain
                  : JSON.stringify(obj.explain, null, 2)
                : "No explain"
            }</pre></div>`
          : "";
      return `<div class='mb-4'><h5 class='fw-semibold'>Mongo</h5>${section(
        "Profile",
        p.profile
      )}${section("Squad", p.squad)}${section("Matches", p.matches)}${section(
        "Competitions",
        p.competitions
      )}</div>`;
    };
    body.innerHTML = renderSQL() + renderMongo();
    bootstrap.Modal.getOrCreateInstance(wrap).show();
  }
</script>

<!-- Clubs market ranking modal -->
<div class="modal fade" id="clubRankModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header align-items-center">
        <h5 class="modal-title me-3">Clubs by total market value</h5>
        <div class="ms-auto d-flex align-items-center gap-2">
          <label for="rank-league" class="small text-muted mb-0"
            >Domestic league</label
          >
          <select
            id="rank-league"
            class="form-select form-select-sm"
            style="min-width: 240px"
          ></select>
        </div>
        <button
          type="button"
          class="btn-close ms-2"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width: 60px">#</th>
                <th>Club</th>
                <th class="text-end">Total (€)</th>
              </tr>
            </thead>
            <tbody id="club-rank-body">
              <tr>
                <td colspan="3" class="text-muted">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
        <small id="club-rank-meta" class="text-muted"></small>
      </div>
    </div>
  </div>
  <script>
    async function loadClubRanking(selectedId, competitionId) {
      const body = document.getElementById("club-rank-body");
      const meta = document.getElementById("club-rank-meta");
      body.innerHTML = `<tr><td colspan="3" class="text-muted">Loading…</td></tr>`;
      try {
        const qs = new URLSearchParams({ limit: "200" });
        if (competitionId) qs.set("competition_id", competitionId);
        const source = getSource();
        const rankBase =
          source === "mongo"
            ? "/api/mongo/clubs/market-ranking"
            : "/api/clubs/market-ranking";
        const data = await fetchJSON(rankBase + "?" + qs.toString());
        const rows = data.rows || [];
        body.innerHTML = "";
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          if (String(r.club_id) === String(selectedId))
            tr.classList.add("table-primary");
          tr.innerHTML = `
            <td><span class="badge bg-secondary-subtle text-dark">${
              r.market_value_rank
            }</span></td>
            <td><a class="text-decoration-none" href="/club?club_id=${
              r.club_id
            }">${r.name || r.club_id}</a></td>
            <td class="text-end">€${Number(
              r.total_market_value_eur || 0
            ).toLocaleString()}</td>`;
          body.appendChild(tr);
        });
        meta.textContent = `Showing ${rows.length} clubs`;
      } catch (e) {
        body.innerHTML = `<tr><td colspan="3" class="text-danger">Failed to load ranking</td></tr>`;
        meta.textContent = "";
      }
    }
    async function loadDomesticLeaguesForRanking(clubId, defaultComp) {
      const sel = document.getElementById("rank-league");
      if (!sel) return null;
      sel.innerHTML = `<option value="">All domestic leagues</option>`;
      try {
        // Limit to this club's own domestic league(s) only
        const base = getSource() === "mongo" ? "/api/mongo" : "/api";
        const data = await fetchJSON(
          `${base}/club/${encodeURIComponent(clubId)}/competitions`
        );
        const leagues = (data.rows || []).filter((r) => {
          const t = (r.type || "").toLowerCase();
          return t === "domestic-league" || t === "domestic_league";
        });
        leagues.forEach((l) => {
          const opt = document.createElement("option");
          opt.value = l.competition_id;
          opt.textContent = l.competition_name || l.competition_id;
          sel.appendChild(opt);
        });
        if (
          defaultComp &&
          [...sel.options].some((o) => o.value === String(defaultComp))
        ) {
          sel.value = String(defaultComp);
        }
        return sel.value || "";
      } catch (e) {
        return "";
      }
    }

    document
      .getElementById("view-ranking")
      ?.addEventListener("click", async () => {
        const cid = qs("club_id");
        const defaultComp =
          document.getElementById("view-ranking")?.dataset?.defaultComp || "";
        await loadDomesticLeaguesForRanking(cid, defaultComp);
        const compSel = document.getElementById("rank-league");
        const compId = compSel ? compSel.value || undefined : undefined;
        if (cid) loadClubRanking(cid, compId);
        if (compSel) {
          compSel.onchange = () => {
            const chosen = compSel.value || undefined;
            if (cid) loadClubRanking(cid, chosen);
          };
        }
      });
  </script>
</div>
{% endblock %}
