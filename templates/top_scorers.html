{% extends "base.html" %} {% block body %}
<div class="container">
  <h1 class="h4 mb-3">Top Scorers</h1>
  <div class="mb-2">
    <label class="form-label me-2">Source</label>
    <select id="ts-source" class="form-select d-inline-block w-auto">
      <option value="sql">SQL</option>
      <option value="mongo">Mongo</option>
    </select>
    <div
      id="ts-compare-wrap"
      class="form-check form-switch d-inline-block ms-3"
      title="Compare SQL vs Mongo"
    >
      <input class="form-check-input" type="checkbox" id="ts-compare" />
      <label class="form-check-label small" for="ts-compare">Compare</label>
    </div>
    <button
      id="ts-perf-more"
      class="btn btn-link btn-sm text-decoration-none ms-2"
      style="display: none"
    >
      More…
    </button>
  </div>

  <form id="ts-form" class="row g-2 align-items-end">
    <div class="col-12 col-md-4">
      <label class="form-label">Competition</label>
      <select
        class="form-select"
        name="competition_id"
        id="competition_id"
        required
      >
        <option value="">Loading competitions…</option>
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label">Season</label>
      <select class="form-select" name="season" id="season" required>
        <option value="">Select season…</option>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Page size</label>
      <input
        class="form-control"
        type="number"
        name="page_size"
        min="5"
        max="100"
        value="20"
      />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Page</label>
      <input class="form-control" type="number" name="page" min="1" value="1" />
    </div>
    <div class="col-12 col-md-1">
      <button class="btn btn-primary w-100">Run</button>
    </div>
  </form>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <small id="ts-meta" class="text-muted"></small>
    <div>
      <button id="prev-btn" class="btn btn-outline-secondary btn-sm me-2">
        Prev
      </button>
      <button id="next-btn" class="btn btn-outline-secondary btn-sm">
        Next
      </button>
    </div>
  </div>

  <div class="table-responsive mt-2">
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>Player</th>
          <th>Club</th>
          <th>Goals</th>
        </tr>
      </thead>
      <tbody id="ts-tbody"></tbody>
    </table>
  </div>
</div>

<script>
  const form = document.getElementById("ts-form");
  const meta = document.getElementById("ts-meta");
  const tbody = document.getElementById("ts-tbody");
  const prevBtn = document.getElementById("prev-btn");
  const nextBtn = document.getElementById("next-btn");
  const compSel = document.getElementById("competition_id");
  const seasonSel = document.getElementById("season");
  let tsPerfSQL = null,
    tsPerfMongo = null;
  let tsMsSQL = 0,
    tsMsMongo = 0;
  let tsLastQS = "";

  async function loadCompetitions() {
    const source = document.getElementById("ts-source").value;
    const base =
      source === "mongo" ? "/api/mongo/competitions" : "/api/competitions";
    const res = await fetch(base);
    const data = await res.json();
    compSel.innerHTML = '<option value="">Select competition…</option>';
    const normalizeType = (t) =>
      String(t || "")
        .toLowerCase()
        .replace(/_/g, "-");
    let defaultCid = null;
    data.rows.forEach((r) => {
      const opt = document.createElement("option");
      opt.value = r.competition_id;
      opt.textContent = r.competition_name || r.competition_id;
      opt.dataset.name = r.competition_name || r.competition_id;
      compSel.appendChild(opt);
      if (!defaultCid) {
        const tt = normalizeType(r.type);
        if (tt.includes("domestic") && tt.includes("league"))
          defaultCid = r.competition_id;
      }
    });
    const url = new URL(window.location.href);
    if (!url.searchParams.get("competition_id") && defaultCid) {
      compSel.value = defaultCid;
    }
    // After competitions load, populate seasons for the selected competition
    if (compSel.value) {
      await loadSeasons(compSel.value);
    }
  }

  async function loadSeasons(competitionId) {
    const source = document.getElementById("ts-source").value;
    const base =
      source === "mongo" ? "/api/mongo/competitions" : "/api/competitions";
    seasonSel.innerHTML = '<option value="">Loading seasons…</option>';
    const res = await fetch(
      `${base}/${encodeURIComponent(competitionId)}/seasons`
    );
    const data = await res.json();
    seasonSel.innerHTML = '<option value="">Select season…</option>';
    let defaultSeason = null;
    data.rows.forEach((r) => {
      const opt = document.createElement("option");
      opt.value = r.season;
      opt.textContent = r.season;
      seasonSel.appendChild(opt);
      if (!defaultSeason) defaultSeason = r.season;
    });
    // Respect deep link if present; otherwise default to latest
    const url = new URL(window.location.href);
    const deepSeason = url.searchParams.get("season");
    if (deepSeason) {
      seasonSel.value = deepSeason;
    } else if (defaultSeason) {
      seasonSel.value = defaultSeason;
    }
  }

  async function loadPage(params) {
    const qs = new URLSearchParams(params).toString();
    const source = document.getElementById("ts-source").value;
    const compare = document.getElementById("ts-compare").checked;
    const base =
      source === "mongo" ? "/api/mongo/top-scorers" : "/api/top-scorers";
    const res = await fetch(base + "?" + qs);
    const data = await res.json();
    tsLastQS = qs;
    let other = null;
    if (compare) {
      const otherBase =
        source === "sql" ? "/api/mongo/top-scorers" : "/api/top-scorers";
      const r2 = await fetch(otherBase + "?" + qs);
      other = await r2.json();
    }
    // store perf and ms
    if (source === "sql") {
      tsPerfSQL = data.perf;
      tsMsSQL = data.ms;
    } else {
      tsPerfMongo = data.perf;
      tsMsMongo = data.ms;
    }
    if (compare && other) {
      if (source === "sql") {
        tsPerfMongo = other.perf;
        tsMsMongo = other.ms;
      } else {
        tsPerfSQL = other.perf;
        tsMsSQL = other.ms;
      }
    }

    const compName =
      compSel.options[compSel.selectedIndex]?.textContent ||
      params.competition_id;
    if (compare && other) {
      const aMs = data.ms,
        bMs = other.ms;
      const aFaster = Number(aMs) < Number(bMs);
      const bFaster = Number(bMs) < Number(aMs);
      const aClass = aFaster ? "faster" : bFaster ? "slower" : "";
      const bClass = bFaster ? "faster" : aFaster ? "slower" : "";
      meta.innerHTML = `Competition ${compName}, Season ${
        params.season
      } — Page ${
        data.page
      } — <span class='meta-badges'><span class='meta-badge ${aClass}'>${source.toUpperCase()} ${aMs} ms</span><span class='meta-sep'>|</span><span class='meta-badge ${bClass}'>${
        source === "sql" ? "Mongo" : "SQL"
      } ${bMs} ms</span></span>`;
    } else {
      meta.innerHTML = `Competition ${compName}, Season ${
        params.season
      } — Page ${
        data.page
      } — <span class='meta-badges'><span class='meta-badge'>${source.toUpperCase()} ${
        data.ms
      } ms</span></span>`;
    }
    tbody.innerHTML = "";
    data.rows.forEach((r, idx) => {
      const tr = document.createElement("tr");
      const absoluteIndex = (data.page - 1) * data.page_size + idx + 1;
      const name = r.player_name || r.player_id;
      const href = `/player/profile?player_id=${r.player_id}`;
      tr.innerHTML = `
      <td>${absoluteIndex}</td>
      <td class="d-flex align-items-center">
        <img src="${
          r.image_url || ""
        }" alt="" width="24" height="24" loading="lazy"
          onerror="this.style.display='none'" class="rounded-circle me-2">
        <a href="${href}" class="link-primary">${name}</a>
      </td>
      <td>${r.club_name || ""}</td>
      <td>${r.goals}</td>`;
      document
        .getElementById("ts-source")
        .addEventListener("change", async () => {
          await loadCompetitions();
          tbody.innerHTML = "";
          meta.textContent = "";
        });
      tbody.appendChild(tr);
    });

    prevBtn.disabled = data.page <= 1;
    // Perf button setup
    const perfBtn = document.getElementById("ts-perf-more");
    // Show the perf button after any successful run to allow lazy fetch
    perfBtn.style.display = "";
    perfBtn.onclick = async () => {
      // Ensure SQL perf is present (fetch with current source if needed)
      if (!tsPerfSQL) {
        try {
          const j = await fetch(`/api/top-scorers?${tsLastQS}&perf=1`).then(
            (r) => r.json()
          );
          if (j.perf) tsPerfSQL = j.perf;
        } catch {}
      }
      // Ensure Mongo perf is present; fetch explain + stats lazily
      if (!tsPerfMongo || tsPerfMongo.explain == null) {
        try {
          const j = await fetch(
            `/api/mongo/top-scorers?${tsLastQS}&perf=1`
          ).then((r) => r.json());
          if (j.perf) tsPerfMongo = j.perf;
        } catch {}
      }
      openTopScorersPerfModal({ perf: tsPerfSQL }, { perf: tsPerfMongo });
    };
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const params = Object.fromEntries(fd.entries());
    await loadPage(params);
  });

  // Update seasons when competition changes and reset page to 1
  compSel.addEventListener("change", async () => {
    if (compSel.value) {
      await loadSeasons(compSel.value);
    } else {
      seasonSel.innerHTML = '<option value="">Select season…</option>';
    }
    const pageEl = form.querySelector('input[name="page"]');
    if (pageEl) pageEl.value = 1;
  });

  prevBtn.addEventListener("click", async () => {
    const fd = new FormData(form);
    const params = Object.fromEntries(fd.entries());
    params.page = Math.max(1, parseInt(params.page || "1") - 1);
    form.querySelector('input[name="page"]').value = params.page;
    await loadPage(params);
  });

  nextBtn.addEventListener("click", async () => {
    const fd = new FormData(form);
    const params = Object.fromEntries(fd.entries());
    params.page = parseInt(params.page || "1") + 1;
    form.querySelector('input[name="page"]').value = params.page;
    await loadPage(params);
  });

  // Initialize competitions and handle deep link
  (async function init() {
    await loadCompetitions();
    const url = new URL(window.location.href);
    ["competition_id", "season", "page", "page_size"].forEach((k) => {
      if (url.searchParams.get(k)) {
        const el = form.querySelector(`[name="${k}"]`);
        if (el) el.value = url.searchParams.get(k);
      }
    });
    // If deep link includes competition, ensure seasons are loaded then optionally submit
    const deepComp = url.searchParams.get("competition_id");
    if (deepComp) {
      await loadSeasons(deepComp);
      const deepSeason = url.searchParams.get("season");
      if (deepSeason) seasonSel.value = deepSeason;
    }
    if (compSel.value && seasonSel.value) {
      form.dispatchEvent(new Event("submit"));
    }
  })();

  function openTopScorersPerfModal(sqlSection, mongoSection) {
    const id = "ts-perf-modal";
    let wrap = document.getElementById(id);
    if (!wrap) {
      wrap = document.createElement("div");
      wrap.id = id;
      wrap.className = "modal fade";
      wrap.tabIndex = -1;
      wrap.innerHTML = `<div class='modal-dialog modal-lg modal-dialog-scrollable'><div class='modal-content'><div class='modal-header'><h5 class='modal-title'>Top Scorers Query Performance</h5><button type='button' class='btn-close' data-bs-dismiss='modal'></button></div><div class='modal-body'><div id='ts-perf-body'></div></div><div class='modal-footer'><button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Close</button></div></div></div>`;
      document.body.appendChild(wrap);
    }
    const body = wrap.querySelector("#ts-perf-body");
    const renderSQL = () => {
      const p = sqlSection?.perf;
      if (!p) return "";
      return `<div class='mb-4'><h6 class='fw-semibold mb-2'>SQL</h6>
        <table class='table table-sm'><tbody>
          <tr><th style='width:180px'>Exec ms</th><td>${
            p.execution_ms ?? "—"
          }</td></tr>
          <tr><th>Diag ms</th><td>${p.diagnostics_ms ?? "—"}</td></tr>
          <tr><th>Rows examined</th><td>${p.rows_examined ?? "—"}</td></tr>
          <tr><th>Rows sent</th><td>${p.rows_sent ?? "—"}</td></tr>
          <tr><th>Explain type</th><td>${p.explain_type ?? "—"}</td></tr>
        </tbody></table>
        <div class='mb-3'><div class='fw-semibold'>Query</div><pre class='small bg-light p-2 rounded border' style='white-space:pre-wrap'>${
          p.query || ""
        }</pre></div>
        <div class='mb-3'><div class='fw-semibold'>Explain</div><pre class='small bg-dark text-light p-2 rounded' style='max-height:240px;overflow:auto;white-space:pre-wrap'>${
          p.explain || "No explain"
        }</pre></div>
      </div>`;
    };
    const renderMongo = () => {
      const mp = mongoSection?.perf || {};
      if (!mp || Object.keys(mp).length === 0) return "";
      const statsRows = mp.stats
        ? Object.keys(mp.stats)
            .map(
              (k) =>
                `<tr><th style='width:180px'>${k}</th><td>${mp.stats[k]}</td></tr>`
            )
            .join("")
        : "";
      const q = mp.query
        ? typeof mp.query === "string"
          ? mp.query
          : JSON.stringify(mp.query, null, 2)
        : "";
      const explainText = mp.explain
        ? typeof mp.explain === "string"
          ? mp.explain
          : JSON.stringify(mp.explain, null, 2)
        : "No explain";
      return `<div class='mb-4'><h6 class='fw-semibold mb-2'>Mongo</h6>
        <table class='table table-sm'><tbody>${statsRows}</tbody></table>
        <div class='mb-3'><div class='fw-semibold'>Query</div><pre class='small bg-light p-2 rounded border' style='white-space:pre-wrap'>${q}</pre></div>
        <div class='mb-3'><div class='fw-semibold'>Explain / Command Output</div><pre class='small bg-dark text-light p-2 rounded' style='max-height:240px;overflow:auto;white-space:pre-wrap'>${explainText}</pre></div>
      </div>`;
    };
    body.innerHTML = renderSQL() + renderMongo();
    bootstrap.Modal.getOrCreateInstance(wrap).show();
  }
</script>
{% endblock %}
