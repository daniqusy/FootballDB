{% extends "base.html" %} {% block body %}

<style>
  :root {
    --ink-900: #111827;
    --ink-700: #374151;
    --ink-500: #6b7280;
    --bg-card: #ffffff;
    --bg-soft: #f8fafc;
    --brand-500: #2563eb;
    --brand-600: #1d4ed8;
  }

  .player-table-header {
    background: linear-gradient(135deg, rgba(37,99,235,0.08), rgba(99,102,241,0.08));
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #eef2f7;
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
  }

  .controls .form-select,
  .controls .form-control {
    min-width: 150px;
  }

  .table-wrapper {
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .table thead th {
    background: #f8fafc;
    font-weight: 600;
    white-space: nowrap;
    border-bottom: 2px solid #e5e7eb;
    vertical-align: middle;
  }

  .table tbody tr {
    border-bottom: 1px solid #e5e7eb;
    transition: background-color 0.15s ease;
  }

  .table tbody tr:hover {
    background: #fbfdff;
  }

  .player-row {
    cursor: pointer;
  }

  .player-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .player-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-soft);
    object-fit: cover;
  }

  .player-details {
    display: flex;
    flex-direction: column;
  }

  .player-name {
    font-weight: 600;
    color: var(--ink-900);
    text-decoration: none;
  }

  .player-name:hover {
    color: var(--brand-600);
  }

  .player-meta {
    font-size: 0.85rem;
    color: var(--ink-500);
  }

  .meta-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    background: #ecf2ff;
    color: var(--brand-600);
    font-size: 0.8rem;
    font-weight: 600;
  }

  .source-badge {
    display: inline-block;
    padding: 0.15rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .source-sql {
    background: #dcfce7;
    color: #166534;
  }

  .source-mongo {
    background: #fed7aa;
    color: #92400e;
  }

  .diff-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: #ef4444;
    border-radius: 50%;
    margin-left: 0.5rem;
  }

  .subtle {
    color: var(--ink-500);
  }

  .pagination-wrap {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--bg-soft);
    border-radius: 0.5rem;
  }

  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #e5e7eb;
    border-top-color: var(--brand-500);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @media (max-width: 768px) {
    .controls { gap: 0.5rem; }
    .controls .form-select,
    .controls .form-control {
      min-width: 120px;
      font-size: 0.9rem;
    }
    .table { font-size: 0.85rem; }
    .player-avatar { width: 32px; height: 32px; }
  }
</style>

<div class="container py-4">
  <!-- Header -->
  <div class="player-table-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0" style="font-weight: 800;">Players</h1>
      <a href="/player/create" class="btn btn-success btn-sm">
        <i class="bi bi-plus-lg"></i> Create Player
      </a>
    </div>
    
    <!-- Controls -->
    <div class="controls">
      <div class="d-flex gap-2 align-items-center">
        <input 
          type="text" 
          id="player-search" 
          class="form-control" 
          placeholder="Search by name..."
          style="min-width: 200px;"
        />
        <button id="player-search-btn" class="btn btn-primary btn-sm">Search</button>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <span class="filter-label subtle" style="margin: 0;">Source</span>
        <select id="player-source" class="form-select form-select-sm" style="min-width: 110px;">
          <option value="sql">SQL</option>
          <option value="mongo">Mongo</option>
        </select>
      </div>

      <div class="form-check form-switch" id="player-compare-wrap" title="Compare SQL vs Mongo">
        <input class="form-check-input" type="checkbox" id="player-compare" />
        <label class="form-check-label small" for="player-compare">Compare</label>
      </div>

      <div class="d-flex gap-2 align-items-center ms-auto">
        <span class="subtle small" id="player-meta"></span>
        <button id="player-refresh" class="btn btn-outline-secondary btn-sm">Refresh</button>
      </div>
    </div>

    <!-- Pagination controls -->
    <div class="controls">
      <span class="subtle small">Page size:</span>
      <select id="player-page-size" class="form-select form-select-sm" style="min-width: 100px;">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div class="table-wrapper">
    <table class="table table-sm mb-0">
      <thead>
        <tr>
          <th style="width: 40%">Player</th>
          <th>Position</th>
          <th class="text-end">Market Value</th>
          <th>Club</th>
          <th class="text-center">Age</th>
          <th class="text-center">Nationality</th>
          <th class="text-center">Source</th>
          <th class="text-center">Action</th>
        </tr>
      </thead>
      <tbody id="player-table-body">
        <tr>
          <td colspan="8" class="text-center py-4">
            <div class="loading-spinner"></div>
            <div class="mt-2">Loading players...</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-wrap">
    <div class="subtle small" id="player-row-count"></div>
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" id="player-prev-wrap">
          <button class="page-link" id="player-prev">← Previous</button>
        </li>
        <li class="page-item disabled">
          <span class="page-link">
            Page <span id="player-current-page">1</span> of <span id="player-total-pages">1</span>
          </span>
        </li>
        <li class="page-item" id="player-next-wrap">
          <button class="page-link" id="player-next">Next →</button>
        </li>
      </ul>
    </nav>
  </div>
</div>

<script>
  async function J(u) {
    const r = await fetch(u);
    return r.json();
  }

  let currentPage = 1;
  let pageSize = 20;
  let searchQuery = "";

  function num(x) {
    return x == null ? "—" : Number(x).toLocaleString();
  }

  function ageFromDob(dobStr) {
    const dob = new Date(dobStr);
    if (isNaN(dob)) return null;
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
    return age;
  }

  async function loadPlayers(page = 1) {
    const source = document.getElementById("player-source").value;
    const pageSize = parseInt(document.getElementById("player-page-size").value);
    const compare = document.getElementById("player-compare").checked;
    const search = document.getElementById("player-search").value.trim();

    const tbody = document.getElementById("player-table-body");
    tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4"><div class="loading-spinner"></div><div class="mt-2">Loading...</div></td></tr>`;

    try {
      let baseUrl = source === 'mongo' ? '/api/mongo/players' : '/api/players';
      let url = `${baseUrl}?page=${page}&page_size=${pageSize}`;
      if (search) url += `&search=${encodeURIComponent(search)}`;

      const res = await J(url);
      let compareRes = null;

      if (compare) {
        const otherBase = source === 'sql' ? '/api/mongo/players' : '/api/players';
        let compareUrl = `${otherBase}?page=${page}&page_size=${pageSize}`;
        if (search) compareUrl += `&search=${encodeURIComponent(search)}`;
        compareRes = await J(compareUrl);
      }

      currentPage = page;
      renderTable(res, compareRes, source);
      updatePagination(res, pageSize);
      updateMeta(res, compareRes, source);
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Error loading players</td></tr>`;
      console.error(err);
    }
  }

  function renderTable(res, compareRes, source) {
    const tbody = document.getElementById("player-table-body");
    const rows = res.rows || [];

    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">No players found</td></tr>`;
      return;
    }

    // If comparing, build a map for quick lookup
    let compareMap = {};
    if (compareRes) {
      (compareRes.rows || []).forEach(r => {
        compareMap[r.player_id] = r;
      });
    }

    tbody.innerHTML = "";
    rows.forEach(row => {
      const compareRow = compareRes ? compareMap[row.player_id] : null;
      let hasDiff = false;

      if (compareRow) {
        hasDiff = row.name !== compareRow.name ||
                  row.market_value_eur !== compareRow.market_value_eur ||
                  row.position !== compareRow.position;
      }

      const age = row.dob ? ageFromDob(row.dob) : null;
      const marketValue = row.market_value_eur ? `€${num(row.market_value_eur)}` : "—";
      const position = row.position ? (row.sub_position ? `${row.position} (${row.sub_position})` : row.position) : "—";
      const nationality = row.country_of_citizenship || "—";
      const club = row.current_club_name || row.club_name || "—";

      const tr = document.createElement("tr");
      tr.classList.add("player-row");
      tr.style.cursor = "pointer";
      
      tr.innerHTML = `
        <td>
          <div class="player-info">
            <img src="${row.image_url || ''}" alt="${row.name}" class="player-avatar" onerror="this.style.display='none'" />
            <div class="player-details">
              <a href="/player/profile?player_id=${row.player_id}" class="player-name">${row.name}</a>
              <span class="player-meta">#${row.player_id}</span>
            </div>
          </div>
        </td>
        <td>
          <span class="meta-badge">${position}</span>
        </td>
        <td class="text-end fw-semibold">${marketValue}</td>
        <td class="subtle">${club}</td>
        <td class="text-center">${age !== null ? `${age}y` : "—"}</td>
        <td class="text-center">${nationality}</td>
        <td class="text-center">
          <span class="source-badge source-${source.toLowerCase()}">${source.toUpperCase()}</span>
          ${hasDiff ? '<span class="diff-indicator" title="Difference detected"></span>' : ''}
        </td>
        <td class="text-center">
          <a href="/player/edit?player_id=${row.player_id}" class="btn btn-link btn-sm text-decoration-none">Edit</a>
          <button class="btn btn-link btn-sm text-decoration-none text-danger delete-player-btn" data-player-id="${row.player_id}" data-player-name="${row.name}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updatePagination(res, pageSize) {
    const totalPlayers = res.total || res.rows.length;
    const totalPages = Math.ceil(totalPlayers / pageSize);

    document.getElementById("player-current-page").textContent = currentPage;
    document.getElementById("player-total-pages").textContent = totalPages;
    document.getElementById("player-row-count").textContent = `Showing ${(currentPage - 1) * pageSize + 1}–${Math.min(currentPage * pageSize, totalPlayers)} of ${totalPlayers}`;

    document.getElementById("player-prev").disabled = currentPage === 1;
    document.getElementById("player-prev-wrap").classList.toggle("disabled", currentPage === 1);
    document.getElementById("player-next").disabled = currentPage === totalPages;
    document.getElementById("player-next-wrap").classList.toggle("disabled", currentPage === totalPages);
  }

  function updateMeta(res, compareRes, source) {
    const metaEl = document.getElementById("player-meta");
    const msA = res.ms || 0;

    if (compareRes) {
      const msB = compareRes.ms || 0;
      const aLabel = source.toUpperCase();
      const bLabel = source === 'sql' ? 'Mongo' : 'SQL';
      const aFaster = msA < msB;
      metaEl.innerHTML = `
        <span class="meta-badge ${aFaster ? 'faster' : ''}">${aLabel} ${msA}ms</span>
        <span style="opacity: 0.5; margin: 0 0.25rem;">|</span>
        <span class="meta-badge ${!aFaster ? 'faster' : ''}">${bLabel} ${msB}ms</span>
      `;
    } else {
      metaEl.innerHTML = `<span class="meta-badge">${source.toUpperCase()} ${msA}ms</span>`;
    }
  }

  // Event listeners
  document.getElementById("player-search-btn").addEventListener("click", () => {
    currentPage = 1;
    loadPlayers(1);
  });

  document.getElementById("player-search").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      currentPage = 1;
      loadPlayers(1);
    }
  });

  document.getElementById("player-refresh").addEventListener("click", () => loadPlayers(currentPage));
  document.getElementById("player-compare").addEventListener("change", () => loadPlayers(currentPage));
  document.getElementById("player-source").addEventListener("change", () => loadPlayers(currentPage));
  document.getElementById("player-page-size").addEventListener("change", () => loadPlayers(1));

  document.getElementById("player-prev").addEventListener("click", () => {
    if (currentPage > 1) loadPlayers(currentPage - 1);
  });

  document.getElementById("player-next").addEventListener("click", () => {
    loadPlayers(currentPage + 1);
  });

  // Delete player handler
  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("delete-player-btn")) {
      e.preventDefault();
      const playerId = e.target.getAttribute("data-player-id");
      const playerName = e.target.getAttribute("data-player-name");
      
      if (confirm(`Are you sure you want to delete ${playerName}? This action cannot be undone.`)) {
        try {
          const res = await fetch(`/api/player/${playerId}`, { method: "DELETE" });
          const data = await res.json();
          
          if (!res.ok) {
            alert("Error: " + (data.error || "Failed to delete player"));
            return;
          }
          
          alert("Player deleted successfully");
          loadPlayers(currentPage);
        } catch (err) {
          alert("Delete failed: " + err.message);
          console.error(err);
        }
      }
    }
  });

  // Initial load
  loadPlayers(1);
</script>

{% endblock %}