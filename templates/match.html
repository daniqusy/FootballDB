{% extends "base.html" %} {% block body %}
<style>
  .meta-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 0.6rem;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #111827;
    font-size: 0.85rem;
    font-weight: 500;
  }
  .meta-badge.faster {
    background: #ecfdf5;
    border-color: #d1fae5;
    color: #065f46;
    font-weight: 600;
  }
  .meta-badge.slower {
    background: #fef2f2;
    border-color: #fee2e2;
    color: #991b1b;
    font-weight: 600;
  }
  .meta-sep {
    color: #9ca3af;
    padding: 0 0.35rem;
  }
  .meta-diff {
    color: #b91c1c;
    font-weight: 600;
    margin-left: 0.35rem;
  }
  .meta-badges {
    display: inline-flex;
    align-items: center;
  }
</style>
<div class="container my-3">
  <!-- Back -->
  <div class="mb-2">
    <a href="/" class="text-decoration-none">&larr; Back to matches</a>
  </div>

  <!-- Match header -->
  <div id="match-header" class="card mb-3">
    <div class="card-body">
      <div
        class="d-flex align-items-center justify-content-between flex-wrap gap-3"
      >
        <div class="d-flex align-items-center gap-3">
          <div class="text-end">
            <div id="home-name" class="h5 mb-1 fw-semibold"></div>
            <div class="text-muted small" id="home-extra"></div>
          </div>
          <div class="h4 mb-0">
            <span id="home-goals">-</span>
            <span class="mx-1">–</span>
            <span id="away-goals">-</span>
          </div>
          <div>
            <div id="away-name" class="h5 mb-1 fw-semibold"></div>
            <div class="text-muted small" id="away-extra"></div>
          </div>
        </div>
        <div class="text-end ms-auto">
          <div id="date-comp" class="fw-semibold"></div>
          <div class="text-muted small" id="venue-ref"></div>
          <small id="match-meta" class="text-muted d-block mb-1"></small>
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="d-inline-flex align-items-center gap-1">
              <label for="match-source" class="small text-muted mb-0"
                >Source</label
              >
              <select
                id="match-source"
                class="form-select form-select-sm"
                style="min-width: 110px"
              >
                <option value="sql" selected>SQL</option>
                <option value="mongo">Mongo</option>
              </select>
            </div>
            <div
              class="form-check form-switch"
              id="match-compare-wrap"
              title="Compare SQL vs Mongo"
            >
              <input
                class="form-check-input"
                type="checkbox"
                id="match-compare"
              />
              <label class="form-check-label small" for="match-compare"
                >Compare</label
              >
            </div>
            <button
              id="match-perf-more"
              class="btn btn-link btn-sm p-0 text-decoration-none"
              style="display: none"
            >
              More…
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Key facts -->
  <div class="row g-3 mb-3" id="facts">
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="text-muted small">Round</div>
          <div id="round" class="fw-semibold">-</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="text-muted small">Attendance</div>
          <div id="attendance" class="fw-semibold">-</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="text-muted small">Formations</div>
          <div id="formations" class="fw-semibold">-</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="text-muted small">Managers</div>
          <div id="managers" class="fw-semibold">-</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Events -->
  <div class="card">
    <div class="card-header fw-semibold">Events timeline</div>
    <ul id="events" class="list-group list-group-flush"></ul>
    <div id="no-events" class="text-center text-muted py-3 d-none">
      No events recorded
    </div>
  </div>
</div>

<script>
  async function fetchJSON(u) {
    const r = await fetch(u);
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  }
  function qs(key) {
    return new URLSearchParams(location.search).get(key);
  }
  function safe(v) {
    return v ?? "";
  }
  function sideClass(side) {
    return side === "home" ? "justify-content-start" : "justify-content-end";
  }
  function badgeFor(type) {
    const map = {
      Goals: "success",
      Cards: "warning",
      Shootout: "dark",
      Substitutions: "info",
    };
    return map[type] || "secondary";
  }

  function renderHeader(g) {
    document.getElementById(
      "home-name"
    ).innerHTML = `<a class="text-decoration-none" href="/club?club_id=${g.home_club_id}">${g.home_name}</a>`;
    document.getElementById(
      "away-name"
    ).innerHTML = `<a class="text-decoration-none" href="/club?club_id=${g.away_club_id}">${g.away_name}</a>`;
    document.getElementById("home-goals").textContent =
      g.home_club_goals ?? "-";
    document.getElementById("away-goals").textContent =
      g.away_club_goals ?? "-";

    document.getElementById("home-extra").textContent = [
      safe(g.home_club_position) ? "Pos " + g.home_club_position : "",
    ]
      .filter(Boolean)
      .join(" ");
    document.getElementById("away-extra").textContent = [
      safe(g.away_club_position) ? "Pos " + g.away_club_position : "",
    ]
      .filter(Boolean)
      .join(" ");

    document.getElementById("date-comp").textContent = [
      g.date_str,
      g.competition_name || g.competition_id,
    ]
      .filter(Boolean)
      .join(" • ");

    // Format match_time if it exists (remove seconds)
    let matchTimeStr = "";
    if (safe(g.match_time)) {
      matchTimeStr = g.match_time.substring(0, 5); // HH:MM format
    }

    document.getElementById("venue-ref").textContent = [
      safe(g.stadium),
      safe(g.referee),
      matchTimeStr,
    ]
      .filter(Boolean)
      .join(" • ");

    document.getElementById("round").textContent = safe(g.round) || "-";
    document.getElementById("attendance").textContent = g.attendance
      ? g.attendance.toLocaleString()
      : "-";
    document.getElementById("formations").textContent =
      [safe(g.home_club_formation), safe(g.away_club_formation)]
        .filter(Boolean)
        .join(" vs ") || "-";
    document.getElementById("managers").textContent =
      [safe(g.home_club_manager_name), safe(g.away_club_manager_name)]
        .filter(Boolean)
        .join(" / ") || "-";
  }

  function playerLink(id, name) {
    if (!id || !name) return "";
    const a = document.createElement("a");
    a.href = `/player/profile?player_id=${encodeURIComponent(id)}`;
    a.textContent = name;
    a.className = "text-decoration-none";
    return a;
  }

  function renderEvents(events) {
    const ul = document.getElementById("events");
    ul.innerHTML = "";
    if (!events || events.length === 0) {
      document.getElementById("no-events").classList.remove("d-none");
      return;
    }
    document.getElementById("no-events").classList.add("d-none");

    events.forEach((ev) => {
      const li = document.createElement("li");
      li.className = "list-group-item";

      const row = document.createElement("div");
      row.className =
        "d-flex " +
        (ev.side === "home" ? "justify-content-start" : "justify-content-end") +
        " align-items-center gap-2";

      // Format minute - show "—" if NULL, 0, or negative
      const minuteText =
        ev.minute !== null && ev.minute >= 0 ? `${ev.minute}'` : "—";

      const minute = document.createElement("span");
      minute.className = "badge text-bg-light border";
      minute.textContent = minuteText;

      const type = document.createElement("span");
      type.className =
        "badge text-bg-" +
        ({
          Goals: "success",
          Cards: "warning",
          Shootout: "dark",
          Substitutions: "info",
        }[ev.event_type] || "secondary");
      type.textContent = ev.event_type;

      const text = document.createElement("span");

      const frag = document.createDocumentFragment();
      let first = true;

      if (ev.player_id && ev.player_name) {
        frag.appendChild(playerLink(ev.player_id, ev.player_name));
        first = false;
      } else if (ev.player_name) {
        frag.appendChild(document.createTextNode(ev.player_name));
        first = false;
      }

      // Assist
      if (ev.player_assist_id && ev.assist_name) {
        frag.appendChild(document.createTextNode(first ? "" : " "));
        frag.appendChild(document.createTextNode("(Assist: "));
        frag.appendChild(playerLink(ev.player_assist_id, ev.assist_name));
        frag.appendChild(document.createTextNode(")"));
        first = false;
      } else if (ev.assist_name) {
        frag.appendChild(document.createTextNode(first ? "" : " "));
        frag.appendChild(
          document.createTextNode("(Assist: " + ev.assist_name + ")")
        );
        first = false;
      }

      // Substitution (player_in)
      if (ev.player_in_id && ev.player_in_name) {
        frag.appendChild(document.createTextNode(first ? "" : " "));
        frag.appendChild(document.createTextNode("(In: "));
        frag.appendChild(playerLink(ev.player_in_id, ev.player_in_name));
        frag.appendChild(document.createTextNode(")"));
        first = false;
      } else if (ev.player_in_name) {
        frag.appendChild(document.createTextNode(first ? "" : " "));
        frag.appendChild(
          document.createTextNode("(In: " + ev.player_in_name + ")")
        );
        first = false;
      }

      // Description
      if (ev.description) {
        frag.appendChild(document.createTextNode(first ? "" : " — "));
        frag.appendChild(document.createTextNode(ev.description));
      }

      text.appendChild(frag);

      row.appendChild(minute);
      row.appendChild(type);
      row.appendChild(text);
      li.appendChild(row);
      ul.appendChild(li);
    });
  }

  function getSource() {
    return document.getElementById("match-source").value;
  }
  function diffObjects(a, b, keys) {
    if (!a || !b) return true;
    for (const k of keys) {
      if (a[k] !== b[k]) return true;
    }
    return false;
  }
  function diffEvents(a, b) {
    if (!Array.isArray(a) || !Array.isArray(b)) return true;
    if (a.length !== b.length) return true;
    for (let i = 0; i < a.length; i++) {
      const ka = [
        "minute",
        "event_type",
        "club_id",
        "player_id",
        "player_assist_id",
        "player_in_id",
      ];
      for (const k of ka) {
        if (a[i][k] !== b[i][k]) return true;
      }
    }
    return false;
  }
  async function loadMatch() {
    const gid = qs("game_id");
    if (!gid) {
      alert("Missing game_id");
      return;
    }
    const source = getSource();
    const compare = document.getElementById("match-compare").checked;
    const primaryUrl =
      (source === "mongo" ? "/api/mongo/match" : "/api/match") +
      `?game_id=${encodeURIComponent(gid)}`;
    try {
      const primary = await fetchJSON(primaryUrl);
      let secondary = null;
      let hasDiff = false;
      if (compare) {
        const otherSrc = source === "sql" ? "mongo" : "sql";
        const secUrl =
          (otherSrc === "mongo" ? "/api/mongo/match" : "/api/match") +
          `?game_id=${encodeURIComponent(gid)}`;
        secondary = await fetchJSON(secUrl);
        if (primary.game && secondary.game) {
          hasDiff = diffObjects(primary.game, secondary.game, [
            "home_club_goals",
            "away_club_goals",
          ]);
        }
        if (!hasDiff) {
          hasDiff = diffEvents(primary.events || [], secondary.events || []);
        }
      }
      if (!primary || !primary.game) {
        document.getElementById(
          "match-header"
        ).innerHTML = `<div class='card-body text-danger'>Match not found.</div>`;
        return;
      }
      renderHeader(primary.game);
      renderEvents(primary.events || []);
      // Meta badges
      const metaEl = document.getElementById("match-meta");
      if (compare && secondary) {
        const aMs = primary.ms;
        const bMs = secondary.ms;
        const aFaster = Number(aMs) < Number(bMs);
        const bFaster = Number(bMs) < Number(aMs);
        const aClass = aFaster ? "faster" : bFaster ? "slower" : "";
        const bClass = bFaster ? "faster" : aFaster ? "slower" : "";
        metaEl.innerHTML = `<span class='meta-badges'><span class='meta-badge ${aClass}'>${source.toUpperCase()} ${aMs} ms</span><span class='meta-sep'>|</span><span class='meta-badge ${bClass}'>${
          source === "sql" ? "Mongo" : "SQL"
        } ${bMs} ms</span>${
          hasDiff ? "<span class='meta-diff'>diff</span>" : ""
        }</span>`;
      } else {
        metaEl.innerHTML = `<span class='meta-badges'><span class='meta-badge'>${source.toUpperCase()} ${
          primary.ms
        } ms</span></span>`;
      }
      // Perf button
      const perfBtn = document.getElementById("match-perf-more");
      const sqlPerf =
        source === "sql" ? primary.perf : compare ? secondary?.perf : null;
      const mongoPerf =
        source === "mongo" ? primary.perf : compare ? secondary?.perf : null;
      const hasPerf = Boolean(sqlPerf || mongoPerf);
      if (hasPerf) {
        perfBtn.style.display = "";
        perfBtn.onclick = async () => {
          let enrichedMongoPerf = mongoPerf;
          if (enrichedMongoPerf && enrichedMongoPerf.explain == null) {
            try {
              const resp = await fetch(
                `/api/mongo/match?game_id=${encodeURIComponent(gid)}&perf=1`
              );
              const j = await resp.json();
              if (j.perf) enrichedMongoPerf = j.perf;
            } catch {}
          }
          openPerfModalMatch({ perf: sqlPerf }, { perf: enrichedMongoPerf });
        };
      } else {
        perfBtn.style.display = "none";
      }
    } catch (e) {
      document.getElementById(
        "match-header"
      ).innerHTML = `<div class='card-body text-danger'>Failed to load match data: ${e.message}</div>`;
    }
  }
  (function init() {
    loadMatch();
    document
      .getElementById("match-source")
      .addEventListener("change", loadMatch);
    document
      .getElementById("match-compare")
      .addEventListener("change", loadMatch);
  })();

  // Performance modal renderer for match details
  function openPerfModalMatch(sqlSection, mongoSection) {
    const id = "match-perf-modal";
    let wrap = document.getElementById(id);
    if (!wrap) {
      wrap = document.createElement("div");
      wrap.id = id;
      wrap.className = "modal fade";
      wrap.tabIndex = -1;
      wrap.innerHTML = `<div class='modal-dialog modal-lg modal-dialog-scrollable'><div class='modal-content'><div class='modal-header'><h5 class='modal-title'>Match Query Performance</h5><button type='button' class='btn-close' data-bs-dismiss='modal'></button></div><div class='modal-body'><div id='match-perf-body'></div></div><div class='modal-footer'><button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Close</button></div></div></div>`;
      document.body.appendChild(wrap);
    }
    const body = wrap.querySelector("#match-perf-body");
    const renderSQL = () => {
      const p = sqlSection?.perf;
      if (!p) return "";
      const game = p.game || {};
      const events = p.events || {};
      return `<div class='mb-4'><h6 class='fw-semibold mb-2'>SQL</h6>
        <table class='table table-sm'><tbody>
          <tr><th style='width:180px'>Game exec ms</th><td>${
            game.execution_ms ?? "—"
          }</td></tr>
          <tr><th>Events exec ms</th><td>${events.execution_ms ?? "—"}</td></tr>
          <tr><th>Game diagnostics ms</th><td>${
            game.diagnostics_ms ?? "—"
          }</td></tr>
          <tr><th>Events diagnostics ms</th><td>${
            events.diagnostics_ms ?? "—"
          }</td></tr>
          <tr><th>Game rows examined</th><td>${
            game.rows_examined ?? "—"
          }</td></tr>
          <tr><th>Events rows examined</th><td>${
            events.rows_examined ?? "—"
          }</td></tr>
        </tbody></table>
        <div class='mb-3'><div class='fw-semibold'>Game Query</div><pre class='small bg-light p-2 rounded border' style='white-space:pre-wrap'>${
          game.query || ""
        }</pre></div>
        <div class='mb-3'><div class='fw-semibold'>Events Query</div><pre class='small bg-light p-2 rounded border' style='white-space:pre-wrap'>${
          events.query || ""
        }</pre></div>
        <div class='mb-3'><div class='fw-semibold'>Game Explain (${
          game.explain_type || "n/a"
        })</div><pre class='small bg-dark text-light p-2 rounded' style='max-height:240px;overflow:auto;white-space:pre-wrap'>${
        game.explain || "No explain"
      }</pre></div>
        <div class='mb-3'><div class='fw-semibold'>Events Explain (${
          events.explain_type || "n/a"
        })</div><pre class='small bg-dark text-light p-2 rounded' style='max-height:240px;overflow:auto;white-space:pre-wrap'>${
        events.explain || "No explain"
      }</pre></div>
      </div>`;
    };
    const renderMongo = () => {
      const mp = mongoSection?.perf || {};
      const q = mp.query
        ? typeof mp.query === "string"
          ? mp.query
          : JSON.stringify(mp.query, null, 2)
        : "";
      const statsRows = mp.stats
        ? Object.keys(mp.stats)
            .map(
              (k) =>
                `<tr><th style='width:180px'>${k}</th><td>${mp.stats[k]}</td></tr>`
            )
            .join("")
        : "";
      const explainText = mp.explain
        ? typeof mp.explain === "string"
          ? mp.explain
          : JSON.stringify(mp.explain, null, 2)
        : "No explain";
      return `<div class='mb-4'><h6 class='fw-semibold mb-2'>Mongo</h6>
        <table class='table table-sm'><tbody>${statsRows}</tbody></table>
        <div class='mb-3'><div class='fw-semibold'>Query</div><pre class='small bg-light p-2 rounded border' style='white-space:pre-wrap'>${q}</pre></div>
        <div class='mb-3'><div class='fw-semibold'>Explain / Command Output</div><pre class='small bg-dark text-light p-2 rounded' style='max-height:240px;overflow:auto;white-space:pre-wrap'>${explainText}</pre></div>
      </div>`;
    };
    body.innerHTML = renderSQL() + renderMongo();
    bootstrap.Modal.getOrCreateInstance(wrap).show();
  }
</script>
{% endblock %}
