{% extends "base.html" %} {% block body %}
<style>
  .ev-row {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 10px 12px;
  }
  .ev-min {
    width: 42px;
    flex: 0 0 42px;
    text-align: right;
    color: #6c757d;
  }
  .ev-pill {
    font-size: 0.75rem;
  }
  .ev-body {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1 1 auto;
  }
  .ev-side-home {
    justify-content: flex-start;
  }
  .ev-side-away {
    justify-content: flex-end;
  }
  .ev-text {
    display: inline;
  }
  .ev-desc {
    color: #6c757d;
  }
  .ev-divider {
    background: #f8f9fa;
    color: #6c757d;
    font-weight: 600;
    padding: 6px 12px;
  }
</style>

<div class="container my-3">
  <!-- Back -->
  <div class="mb-2">
    <a href="/" class="text-decoration-none">&larr; Back to matches</a>
  </div>

  <!-- Match header -->
  <div id="match-header" class="card mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
          <div class="text-end">
            <div id="home-name" class="h5 mb-1 fw-semibold"></div>
            <div class="text-muted small" id="home-extra"></div>
          </div>
          <div class="h4 mb-0">
            <span id="home-goals">-</span>
            <span class="mx-1">–</span>
            <span id="away-goals">-</span>
          </div>
          <div>
            <div id="away-name" class="h5 mb-1 fw-semibold"></div>
            <div class="text-muted small" id="away-extra"></div>
          </div>
        </div>
        <div class="text-end">
          <div id="date-comp" class="fw-semibold"></div>
          <div class="text-muted small" id="venue-ref"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Key facts -->
  <div class="row g-3 mb-3" id="facts">
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="text-muted small">Round</div>
          <div id="round" class="fw-semibold">-</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="text-muted small">Attendance</div>
          <div id="attendance" class="fw-semibold">-</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="text-muted small">Formations</div>
          <div id="formations" class="fw-semibold">-</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="text-muted small">Managers</div>
          <div id="managers" class="fw-semibold">-</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Events -->
  <div class="card">
    <div class="card-header d-flex align-items-center justify-content-between">
      <span class="fw-semibold">Events timeline</span>
      <div class="form-check form-switch">
        <input
          class="form-check-input"
          type="checkbox"
          id="toggle-desc"
          checked
        />
        <label class="form-check-label" for="toggle-desc"
          >Show descriptions</label
        >
      </div>
    </div>
    <div class="list-group list-group-flush" id="events"></div>
    <div id="no-events" class="text-center text-muted py-3 d-none">
      No events recorded
    </div>
  </div>
</div>

<script>
  async function fetchJSON(u) {
    const r = await fetch(u);
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  }
  function qs(key) {
    return new URLSearchParams(location.search).get(key);
  }
  function safe(v) {
    return v ?? "";
  }
  function sideClass(side) {
    return side === "home" ? "ev-side-home" : "ev-side-away";
  }
  function badgeFor(type) {
    const map = {
      Goals: "success",
      Cards: "warning",
      Shootout: "dark",
      Substitutions: "info",
    };
    return map[type] || "secondary";
  }

  function renderHeader(g) {
    document.getElementById("home-name").textContent = g.home_name;
    document.getElementById("away-name").textContent = g.away_name;
    document.getElementById("home-goals").textContent = g.home_club_goals;
    document.getElementById("away-goals").textContent = g.away_club_goals;

    document.getElementById("home-extra").textContent = [
      safe(g.home_club_position) ? "Pos " + g.home_club_position : "",
    ]
      .filter(Boolean)
      .join(" ");
    document.getElementById("away-extra").textContent = [
      safe(g.away_club_position) ? "Pos " + g.away_club_position : "",
    ]
      .filter(Boolean)
      .join(" ");

    document.getElementById("date-comp").textContent = [
      g.date_str,
      g.competition_id,
      g.competition_type,
    ]
      .filter(Boolean)
      .join(" • ");
    document.getElementById("venue-ref").textContent = [
      safe(g.stadium),
      safe(g.referee),
      safe(g.match_time),
    ]
      .filter(Boolean)
      .join(" • ");

    document.getElementById("round").textContent = safe(g.round) || "-";
    document.getElementById("attendance").textContent = g.attendance
      ? g.attendance.toLocaleString()
      : "-";
    document.getElementById("formations").textContent =
      [safe(g.home_club_formation), safe(g.away_club_formation)]
        .filter(Boolean)
        .join(" vs ") || "-";
    document.getElementById("managers").textContent =
      [safe(g.home_club_manager_name), safe(g.away_club_manager_name)]
        .filter(Boolean)
        .join(" / ") || "-";
  }

  function playerLink(id, name) {
    if (!id || !name) return "";
    const a = document.createElement("a");
    a.href = `/player/profile?player_id=${encodeURIComponent(id)}`;
    a.textContent = name;
    a.className = "text-decoration-none";
    return a;
  }

  function eventLine(ev, showDesc) {
    const row = document.createElement("div");
    row.className = `list-group-item ev-row ${sideClass(ev.side)}`;

    const min = document.createElement("div");
    min.className = "ev-min";
    min.textContent = (ev.minute ?? 0) + "'";
    row.appendChild(min);

    const body = document.createElement("div");
    body.className = "ev-body";

    // type pill
    const pill = document.createElement("span");
    pill.className = `badge text-bg-${badgeFor(ev.event_type)} ev-pill`;
    pill.textContent = ev.event_type;
    body.appendChild(pill);

    // text: names always present, description optional
    const text = document.createElement("span");
    text.className = "ev-text";

    const frag = document.createDocumentFragment();
    // main player
    if (ev.player_name) {
      frag.appendChild(playerLink(ev.player_id, ev.player_name));
    }
    // assist
    if (ev.assist_name) {
      frag.appendChild(document.createTextNode(" (Assist: "));
      frag.appendChild(playerLink(ev.player_assist_id, ev.assist_name));
      frag.appendChild(document.createTextNode(")"));
    }
    // substitution (player_in)
    if (ev.player_in_name) {
      frag.appendChild(document.createTextNode(" (In: "));
      frag.appendChild(playerLink(ev.player_in_id, ev.player_in_name));
      frag.appendChild(document.createTextNode(")"));
    }
    // description toggle
    const desc = document.createElement("span");
    desc.className = "ev-desc";
    if (ev.description) {
      desc.textContent = " — " + ev.description;
      desc.style.display = showDesc ? "inline" : "none";
    }

    text.appendChild(frag);
    text.appendChild(desc);
    body.appendChild(text);

    row.appendChild(body);
    return row;
  }

  function divider(label) {
    const div = document.createElement("div");
    div.className = "ev-divider";
    div.textContent = label;
    return div;
  }

  function renderEvents(events, showDesc) {
    const box = document.getElementById("events");
    box.innerHTML = "";
    if (!events || events.length === 0) {
      document.getElementById("no-events").classList.remove("d-none");
      return;
    }
    document.getElementById("no-events").classList.add("d-none");

    // First half
    let insertedHT = false;
    events.forEach((ev) => {
      if (!insertedHT && (ev.minute ?? 0) >= 45) {
        box.appendChild(divider("HT"));
        insertedHT = true;
      }
      box.appendChild(eventLine(ev, showDesc));
    });
    // Ensure HT even if no events around 45'
    if (!insertedHT)
      box.insertBefore(divider("HT"), box.firstChild?.nextSibling || null);

    // FT footer line
    box.appendChild(divider("FT"));
  }

  // Wire toggle
  let lastEvents = [];
  function wireDescToggle() {
    const sw = document.getElementById("toggle-desc");
    sw.addEventListener("change", () => renderEvents(lastEvents, sw.checked));
  }

  async function init() {
    const gid = qs("game_id");
    if (!gid) {
      alert("Missing game_id");
      return;
    }
    try {
      const data = await fetchJSON(
        `/api/match?game_id=${encodeURIComponent(gid)}`
      );
      if (!data.game) {
        alert("Match not found");
        return;
      }
      renderHeader(data.game);
      renderEvents(data.events || []);
    } catch (e) {
      console.error(e);
      alert("Failed to load match data");
    }
  }
  init();
</script>
{% endblock %}
