{% extends "base.html" %}
{% block body %}
<div class="container">
  <h1 class="h4 mb-3">Top Scorers</h1>

  <form id="ts-form" class="row g-2 align-items-end">
    <div class="col-12 col-md-3">
      <label class="form-label">Competition ID</label>
      <input class="form-control" name="competition_id" placeholder="e.g., 39" required>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label">Season</label>
      <input class="form-control" name="season" placeholder="e.g., 2023" required>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Page size</label>
      <input class="form-control" type="number" name="page_size" min="5" max="100" value="20">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Page</label>
      <input class="form-control" type="number" name="page" min="1" value="1">
    </div>
    <div class="col-12 col-md-2">
      <button class="btn btn-primary w-100">Run</button>
    </div>
  </form>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <small id="ts-meta" class="text-muted"></small>
    <div>
      <button id="prev-btn" class="btn btn-outline-secondary btn-sm me-2">Prev</button>
      <button id="next-btn" class="btn btn-outline-secondary btn-sm">Next</button>
    </div>
  </div>

  <div class="table-responsive mt-2">
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>Player ID</th>
          <th>Goals</th>
        </tr>
      </thead>
      <tbody id="ts-tbody"></tbody>
    </table>
  </div>
</div>

<script>
const form = document.getElementById('ts-form');
const meta = document.getElementById('ts-meta');
const tbody = document.getElementById('ts-tbody');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');

async function loadPage(params) {
  const qs = new URLSearchParams(params).toString();
  const res = await fetch('/api/top-scorers?' + qs);
  const data = await res.json();

  meta.textContent = `Competition ${params.competition_id}, Season ${params.season} — Page ${data.page} — Query time: ${data.ms} ms`;
  tbody.innerHTML = '';
  data.rows.forEach((r, idx) => {
    const tr = document.createElement('tr');
    const absoluteIndex = (data.page - 1) * data.page_size + idx + 1;
    tr.innerHTML = `
      <td>${absoluteIndex}</td>
      <td>
        <a href="/player/form?player_id=${r.player_id}&competition_id=${params.competition_id}&season=${params.season}" class="link-primary">
          ${r.player_id}
        </a>
      </td>
      <td>${r.goals}</td>`;
    tbody.appendChild(tr);
  });

  // Enable/disable nav buttons
  prevBtn.disabled = (data.page <= 1);
  // Next is optimistic since we don't know total; allow user to click, empty result just shows blank.
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(form);
  const params = Object.fromEntries(fd.entries());
  await loadPage(params);
});

prevBtn.addEventListener('click', async () => {
  const fd = new FormData(form);
  const params = Object.fromEntries(fd.entries());
  params.page = Math.max(1, parseInt(params.page || '1') - 1);
  form.querySelector('input[name="page"]').value = params.page;
  await loadPage(params);
});

nextBtn.addEventListener('click', async () => {
  const fd = new FormData(form);
  const params = Object.fromEntries(fd.entries());
  params.page = (parseInt(params.page || '1') + 1);
  form.querySelector('input[name="page"]').value = params.page;
  await loadPage(params);
});

// If query params are present (deep link), prefill and auto-run
(function initFromQuery() {
  const url = new URL(window.location.href);
  ['competition_id','season','page','page_size'].forEach(k=>{
    if (url.searchParams.get(k)) {
      const el = form.querySelector(`[name="${k}"]`);
      if (el) el.value = url.searchParams.get(k);
    }
  });
  if (url.searchParams.get('competition_id') && url.searchParams.get('season')) {
    form.dispatchEvent(new Event('submit'));
  }
})();
</script>
{% endblock %}
